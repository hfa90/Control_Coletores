<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento de Coletores - Drogasil</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/script.js') }}" defer></script>
    <script src="/static/js/icons.js" defer></script>
    <link rel="shortcut icon" href="/static/favicon.ico">
</head>

<body>
    <header>
        <div class="header-container">
            <div class="logo">
                <i class="fas fa-barcode"></i>
                <span>Sistema de Controle de Coletores em Centro de Distribuição</span>
            </div>
            <div class="user-info">
                <span>{{ session.get('usuario_nome', 'Usuário') }}</span>
                <img src="/static/img/user-placeholder.png" alt="Usuário">
            </div>
        </div>
    </header>

    <div class="container">
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon">
                        <i class="fas fa-tablet-alt"></i>
                    </div>
                </div>
                <div class="stat-card-title">Total de Coletores</div>
                <div class="stat-card-value" id="totalCollectors">0</div>
                <div class="stat-card-footer">
                    <i class="fas fa-check-circle"></i>
                    <span>Inventário completo</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon">
                        <i class="fas fa-user-check"></i>
                    </div>
                </div>
                <div class="stat-card-title">Em Uso Agora</div>
                <div class="stat-card-value" id="activeCollectors">0</div>
                <div class="stat-card-footer">
                    <i class="fas fa-arrow-up"></i>
                    <span id="activeChange">+0 desde ontem</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                </div>
                <div class="stat-card-title">Com Problemas</div>
                <div class="stat-card-value" id="issueCollectors">0</div>
                <div class="stat-card-footer" style="color: var(--danger);">
                    <i class="fas fa-arrow-up"></i>
                    <span id="issueChange">+0 desde ontem</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon">
                        <i class="fas fa-sync"></i>
                    </div>
                </div>
                <div class="stat-card-title">Manutenções Pendentes</div>
                <div class="stat-card-value" id="maintenanceCollectors">0</div>
                <div class="stat-card-footer" style="color: var(--warning);">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="maintenancePriority">0 prioritárias</span>
                </div>
            </div>
        </div>

        <!-- Seção de coletores em uso -->
        <div class="collectors-in-use">
            <div class="collectors-header">
                <div class="collectors-title">Coletores em Uso Agora</div>
                <div class="collector-actions">
                    <button class="btn btn-outline" id="refreshActiveCollectors">
                        <i class="fas fa-sync"></i>
                        <span>Atualizar</span>
                    </button>
                </div>
            </div>
            <div class="collector-usage-list" id="activeCollectorsList">
                <!-- Os itens serão inseridos via JavaScript -->
            </div>
        </div>

        <!-- Tabela de gerenciamento de coletores -->
        <div class="section-title">
            <span>Gerenciamento de Coletores</span>
            <div class="buttons">
                <button class="btn btn-primary" id="btnAddCollector">
                    <i class="fas fa-plus"></i>
                    <span>Adicionar Coletor</span>
                </button>
                <button class="btn btn-success" id="btnManageUsers">
                    <i class="fas fa-users"></i>
                    <span>Gerenciar Colaboradores</span>
                </button>


                <button class="btn btn-outline" id="btnExportReport">
                    <i class="fas fa-file-export"></i>
                    <span>Exportar Relatório</span>
                </button>

                <button class="btn btn-primary" id="btnSelectionPage"
                    style="background-color: var(--success); border-color: var(--success);">
                    <i class="fas fa-tablet-alt"></i>
                    <span>Seleção de Coletores</span>
                </button>

                <button class="btn btn-outline" id="btnExportJSON">
                    <i class="fas fa-file-export"></i>
                    <span>Exportar JSON</span>
                </button>
                <button class="btn btn-outline" id="btnImportJSON">
                    <i class="fas fa-file-import"></i>
                    <span>Importar JSON</span>
                </button>
                <button class="btn btn-outline" id="btnSaveLocal">
                    <i class="fas fa-save"></i>
                    <span>Salvar no Navegador</span>
                </button>
                <button class="btn btn-outline" id="btnLoadLocal">
                    <i class="fas fa-download"></i>
                    <span>Carregar do Navegador</span>
                </button>

                <button class="btn btn-primary" id="btnSelectionPage"
                    style="background-color: #28a745; border-color: #28a745; margin-left: 10px;">
                    <i class="fas fa-tablet-alt"></i>
                    <span>Seleção de Coletores</span>
                </button>

            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Usuário Atual</th>
                    <th>Setor</th>
                    <th>Status</th>
                    <th>Tempo de Uso</th>
                    <th>Bateria</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="collectorsTableBody">
                <!-- Os itens serão inseridos via JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Modal para adicionar/editar coletor -->
    <div class="modal-backdrop" id="collectorModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Adicionar Novo Coletor</h3>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="collectorForm">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="collectorId">ID do Coletor</label>
                                <input type="text" class="form-control" id="collectorId" placeholder="Ex: 001" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="collectorModel">Modelo</label>
                                <input type="text" class="form-control" id="collectorModel" value="Honeywell EDA61k"
                                    readonly>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="collectorSerial">Número de Série</label>
                        <input type="text" class="form-control" id="collectorSerial" placeholder="Número de série"
                            required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="collectorUser">Usuário Atual</label>
                        <select class="form-control" id="collectorUser">
                            <option value="">Selecione um usuário</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="collectorSector">Setor</label>
                                <select class="form-control" id="collectorSector">
                                    <option value="">Selecione um setor</option>
                                    <option value="Expedição">Expedição</option>
                                    <option value="Armazenamento">Armazenamento</option>
                                    <option value="Separação">Separação</option>
                                    <option value="Conferência">Conferência</option>
                                    <option value="TI">TI</option>
                                    <option value="Pcp">Pcp</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="collectorStatus">Status</label>
                                <select class="form-control" id="collectorStatus" required>
                                    <option value="Ativo">Ativo</option>
                                    <option value="Inativo">Inativo</option>
                                    <option value="Com problema">Com problema</option>
                                    <option value="Em manutenção">Em manutenção</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="collectorBattery">Bateria (%)</label>
                                <input type="number" class="form-control" id="collectorBattery" min="0" max="100"
                                    value="100">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label" for="collectorUsageTime">Tempo de Uso</label>
                                <input type="text" class="form-control" id="collectorUsageTime"
                                    placeholder="Ex: 2h 30m">
                            </div>
                        </div>
                    </div>
                    <div class="form-group" id="issueGroup">
                        <label class="form-label" for="collectorIssue">Descrição do Problema</label>
                        <textarea class="form-control" id="collectorIssue" rows="3"
                            placeholder="Descreva o problema do coletor"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="collectorNotes">Observações</label>
                        <textarea class="form-control" id="collectorNotes" rows="3"
                            placeholder="Observações adicionais"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelModal">Cancelar</button>
                <button class="btn btn-primary" id="saveCollector">Salvar</button>

            </div>
        </div>
    </div>

    <!-- Modal para gerenciar colaboradores -->
    <div class="modal-backdrop" id="usersModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Gerenciar Colaboradores</h3>
                <button class="modal-close" id="closeUsersModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" id="btnAddUser">
                        <i class="fas fa-plus"></i>
                        <span>Adicionar Colaborador</span>
                    </button>
                </div>

                <table style="width: 100%; margin-bottom: 20px;">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Matrícula</th>
                            <th>Setor</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- Os usuários serão inseridos via JavaScript -->
                    </tbody>
                </table>

                <div id="userFormContainer" style="display: none; border-top: 1px solid #e9ecef; padding-top: 20px;">
                    <h4 id="userFormTitle">Adicionar Colaborador</h4>
                    <form id="userForm">
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="userName">Nome Completo</label>
                                    <input type="text" class="form-control" id="userName"
                                        placeholder="Nome do colaborador" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="userCode">Matrícula</label>
                                    <input type="text" class="form-control" id="userCode" placeholder="Ex: MA12345"
                                        required>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="userSector">Setor</label>
                                    <select class="form-control" id="userSector" required>
                                        <option value="">Selecione um setor</option>
                                        <option value="Expedição">Expedição</option>
                                        <option value="Armazenamento">Armazenamento</option>
                                        <option value="Separação">Separação</option>
                                        <option value="Conferência">Conferência</option>
                                        <option value="TI">TI</option>
                                        <option value="Pcp">Pcp</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="userRole">Função</label>
                                    <input type="text" class="form-control" id="userRole"
                                        placeholder="Ex: Operador, Supervisor">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="userNotes">Observações</label>
                            <textarea class="form-control" id="userNotes" rows="2"
                                placeholder="Observações adicionais"></textarea>
                        </div>
                        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                            <button type="button" class="btn btn-outline" id="cancelUserForm">Cancelar</button>
                            <button type="button" class="btn btn-primary" id="saveUser">Salvar</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelUsersModal">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Botão flutuante para painel de coletores -->
    <button id="openCollectorsPanel" class="btn btn-primary" title="Ver Coletores em Uso">
        <i class="fas fa-tablet-alt"></i>
    </button>

    <script src="/static/js/script.js"></script>
    <script src="/static/js/floating-button.js" defer></script>

    // Adicione este código ao final do seu arquivo index.html
    <script>
        // Função para garantir que o botão esteja sempre visível para o usuário especial
        function manterBotaoVisivel() {
            fetch('/api/session/user')
                .then(response => response.json())
                .then(data => {
                    console.log("Verificando permissões...");
                    console.log("Matrícula atual:", data.matricula);

                    if (data.matricula === 'MA201990') {
                        console.log("✓ Usuário com permissão especial detectado!");

                        // Forçar a exibição do botão
                        const btnManageUsers = document.getElementById('btnManageUsers');
                        if (btnManageUsers) {
                            if (btnManageUsers.style.display === 'none') {
                                console.log("Restaurando visibilidade do botão...");
                            }
                            btnManageUsers.style.display = 'flex';

                            // Adicionar uma classe especial para identificar que este elemento não deve ser ocultado
                            btnManageUsers.classList.add('permissao-especial');

                            // Acrescentar o indicador visual de permissão especial
                            if (!document.getElementById('special-indicator')) {
                                const indicator = document.createElement('span');
                                indicator.id = 'special-indicator';
                                indicator.style.position = 'absolute';
                                indicator.style.top = '-8px';
                                indicator.style.right = '-8px';
                                indicator.style.backgroundColor = '#e02020';
                                indicator.style.color = 'white';
                                indicator.style.width = '20px';
                                indicator.style.height = '20px';
                                indicator.style.borderRadius = '50%';
                                indicator.style.display = 'flex';
                                indicator.style.alignItems = 'center';
                                indicator.style.justifyContent = 'center';
                                indicator.style.fontSize = '12px';
                                indicator.style.boxShadow = '0 2px 5px rgba(0, 0, 0, 0.2)';
                                indicator.style.border = '2px solid white';
                                indicator.innerHTML = '<i class="fas fa-key"></i>';
                                indicator.title = 'Você tem permissão especial para gerenciar colaboradores';
                                btnManageUsers.style.position = 'relative';
                                btnManageUsers.appendChild(indicator);
                            }
                        } else {
                            console.log("Botão de gerenciar colaboradores não encontrado!");
                        }
                    }
                })
                .catch(error => console.error('Erro ao verificar sessão:', error));
        }

        // Executar a função imediatamente e depois a cada 500ms
        manterBotaoVisivel();
        setInterval(manterBotaoVisivel, 500);

        // Sobrescrever a função que pode estar ocultando o botão
        // Esta é uma técnica mais agressiva, use apenas se a abordagem acima não funcionar
        document.addEventListener('DOMContentLoaded', function () {
            // Aguardar 1 segundo para garantir que todas as outras funções foram executadas
            setTimeout(function () {
                const originalDisplayProperty = Object.getOwnPropertyDescriptor(HTMLElement.prototype, 'style').get;

                // Monitorar tentativas de ocultar o botão
                const elementosProtegidos = [document.getElementById('btnManageUsers')];

                // Sobrescrever o método que oculta elementos
                const observer = new MutationObserver(function (mutations) {
                    mutations.forEach(function (mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                            const elemento = mutation.target;
                            if (elemento.classList.contains('permissao-especial') && elemento.style.display === 'none') {
                                console.log("Tentativa de ocultar elemento protegido detectada e bloqueada");
                                elemento.style.display = 'flex';
                            }
                        }
                    });
                });

                // Aplicar o observer aos elementos protegidos
                elementosProtegidos.forEach(function (elemento) {
                    if (elemento) {
                        observer.observe(elemento, { attributes: true });
                    }
                });

                console.log("Proteção aplicada para o botão de gerenciar colaboradores");
                manterBotaoVisivel(); // Garantir que o botão esteja visível após todas as inicializações
            }, 1000);
        });
    </script>

    // Substitua o código de verificação de permissão no seu script.js ou coloque
    // este código no final do seu arquivo index.html, antes do
</body>

<script>
    // Variável global para armazenar se o usuário tem permissão especial
    let temPermissaoEspecial = false;

    // Função para verificar se o usuário tem permissão para gerenciar colaboradores
    function verificarPermissaoEspecial() {
        fetch('/api/session/user')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro ao obter dados da sessão: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Dados da sessão:", data);
                console.log("Matrícula atual:", data.matricula);

                // Verificar se é o usuário especial
                const matriculaEspecial = 'MA201990';
                temPermissaoEspecial = (data.matricula === matriculaEspecial);

                console.log("Tem permissão especial:", temPermissaoEspecial);

                // Atualizar a interface com base na permissão
                atualizarBotoesGerenciamento();
            })
            .catch(error => {
                console.error('Erro ao verificar permissão especial:', error);
                temPermissaoEspecial = false;
                atualizarBotoesGerenciamento();
            });
    }

    // Função para atualizar botões com base na permissão
    function atualizarBotoesGerenciamento() {
        // Botão principal de gerenciar colaboradores
        const btnManageUsers = document.getElementById('btnManageUsers');

        if (btnManageUsers) {
            if (temPermissaoEspecial) {
                btnManageUsers.style.display = 'flex';

                // Adicionar indicador visual para o usuário especial
                if (!document.getElementById('special-indicator')) {
                    const indicator = document.createElement('span');
                    indicator.id = 'special-indicator';
                    indicator.style.position = 'absolute';
                    indicator.style.top = '-8px';
                    indicator.style.right = '-8px';
                    indicator.style.backgroundColor = '#e02020';
                    indicator.style.color = 'white';
                    indicator.style.width = '20px';
                    indicator.style.height = '20px';
                    indicator.style.borderRadius = '50%';
                    indicator.style.display = 'flex';
                    indicator.style.alignItems = 'center';
                    indicator.style.justifyContent = 'center';
                    indicator.style.fontSize = '12px';
                    indicator.style.boxShadow = '0 2px 5px rgba(0, 0, 0, 0.2)';
                    indicator.style.border = '2px solid white';
                    indicator.innerHTML = '<i class="fas fa-key"></i>';
                    indicator.title = 'Você tem permissão especial para gerenciar colaboradores';
                    btnManageUsers.style.position = 'relative';
                    btnManageUsers.appendChild(indicator);
                }
            } else {
                btnManageUsers.style.display = 'flex'; // Mostrar para todos, mas controlamos o acesso ao clicar
            }
        }
    }

    // Modificar a função de clique no botão gerenciar usuários
    function configurarEventoBotaoGerenciarUsuarios() {
        const btnManageUsers = document.getElementById('btnManageUsers');
        if (btnManageUsers) {
            // Remover event listeners antigos
            const newBtn = btnManageUsers.cloneNode(true);
            btnManageUsers.parentNode.replaceChild(newBtn, btnManageUsers);

            // Adicionar o novo event listener
            newBtn.addEventListener('click', function (e) {
                e.preventDefault();

                if (temPermissaoEspecial) {
                    // Se tem permissão, abre o modal normalmente
                    openUsersModal();
                } else {
                    // Se não tem permissão, exibe o aviso de permissão negada
                    exibirAvisoPermissao();
                }
            });
        }
    }

    // Função para exibir aviso de permissão negada
    function exibirAvisoPermissao() {
        // Verificar se já existe um aviso na tela
        if (document.getElementById('avisoPermissao')) {
            return;
        }

        // Criar o container do aviso
        const avisoContainer = document.createElement('div');
        avisoContainer.className = 'modal-backdrop active';
        avisoContainer.id = 'avisoPermissao';
        avisoContainer.style.zIndex = '2000'; // Garantir que fique acima de outros modais

        const avisoModal = document.createElement('div');
        avisoModal.className = 'modal';
        avisoModal.style.maxWidth = '450px';

        avisoModal.innerHTML = `
        <div class="modal-header" style="background-color: #dc3545; color: white;">
            <h3 class="modal-title">Permissão Negada</h3>
            <button class="modal-close" id="fecharAviso">&times;</button>
        </div>
        <div class="modal-body">
            <div style="text-align: center; margin-bottom: 20px;">
                <i class="fas fa-lock" style="font-size: 48px; color: #dc3545; margin-bottom: 15px;"></i>
                <p>Você não tem permissão para gerenciar colaboradores.</p>
                <p style="margin-top: 10px;"><strong>Apenas o usuário com matrícula MA201990 pode realizar esta ação.</strong></p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" id="entendidoBtn" style="background-color: #dc3545; border-color: #dc3545;">Entendido</button>
        </div>
    `;

        avisoContainer.appendChild(avisoModal);
        document.body.appendChild(avisoContainer);

        // Adicionar eventos aos botões
        document.getElementById('fecharAviso').addEventListener('click', () => {
            document.body.removeChild(avisoContainer);
        });

        document.getElementById('entendidoBtn').addEventListener('click', () => {
            document.body.removeChild(avisoContainer);
        });
    }

    // Corrigir a função openUsersModal para não mostrar o aviso de permissão negada
    function openUsersModal() {
        // Apenas processar se o usuário tiver permissão
        if (temPermissaoEspecial) {
            // Verificar se o modal já está sendo exibido
            const existingModal = document.getElementById('usersModal');
            if (existingModal && existingModal.classList.contains('active')) {
                return;
            }

            // Renderizar a tabela de usuários
            renderUsersTable();

            // Ocultar o formulário
            const userFormContainer = document.getElementById('userFormContainer');
            if (userFormContainer) {
                userFormContainer.style.display = 'none';
            }

            // Mostrar o modal
            const usersModal = document.getElementById('usersModal');
            if (usersModal) {
                usersModal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }
    }

    // Inicializar quando o documento estiver carregado
    document.addEventListener('DOMContentLoaded', function () {
        // Verificar permissões
        verificarPermissaoEspecial();

        // Configurar evento do botão após 500ms (garantir que todos os elementos foram carregados)
        setTimeout(configurarEventoBotaoGerenciarUsuarios, 500);
    });
</script>

// Adicione estas funções ao arquivo script.js
// ou coloque no final do seu arquivo index.html, antes do </body>

<script>
    // Sobrescrever a função renderUsersTable
    function renderUsersTable() {
        const usersTableBodyEl = document.getElementById('usersTableBody');
        if (!usersTableBodyEl) return;

        usersTableBodyEl.innerHTML = '';

        // Verificar se o usuário realmente tem permissão
        if (!temPermissaoEspecial) {
            console.error("Tentativa de renderizar tabela de usuários sem permissão");
            return;
        }

        users.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
            <td>${user.nome}</td>
            <td>${user.matricula}</td>
            <td>${user.setor}</td>
            <td>
                <div class="actions">
                    <button class="btn-icon btn-edit-user" data-id="${user.id}"><i class="fas fa-pen"></i></button>
                    <button class="btn-icon btn-delete-user" data-id="${user.id}"><i class="fas fa-trash"></i></button>
                </div>
            </td>
        `;

            usersTableBodyEl.appendChild(row);
        });

        // Adicionar eventos aos botões de ação
        document.querySelectorAll('.btn-edit-user').forEach(btn => {
            btn.addEventListener('click', () => {
                const userId = parseInt(btn.dataset.id);
                openEditUserForm(userId);
            });
        });

        document.querySelectorAll('.btn-delete-user').forEach(btn => {
            btn.addEventListener('click', () => {
                const userId = parseInt(btn.dataset.id);
                if (confirm('Tem certeza que deseja remover este colaborador?')) {
                    deleteUser(userId);
                }
            });
        });
    }

    // Sobrescrever a função saveUser para verificar permissão novamente
    function saveUser() {
        // Verificar se tem permissão para manipular usuários
        if (!temPermissaoEspecial) {
            alert('Você não tem permissão para adicionar ou editar colaboradores. Apenas o usuário com matrícula MA201990 pode realizar esta ação.');
            return;
        }

        // Verificar se o formulário é válido
        const userForm = document.getElementById('userForm');
        if (!userForm || !userForm.checkValidity()) {
            if (userForm) userForm.reportValidity();
            return;
        }

        const userNameInput = document.getElementById('userName');
        const userCodeInput = document.getElementById('userCode');
        const userSectorSelect = document.getElementById('userSector');
        const userRoleInput = document.getElementById('userRole');
        const userNotesTextarea = document.getElementById('userNotes');

        if (!userNameInput || !userCodeInput || !userSectorSelect) {
            console.error("Elementos do formulário não encontrados");
            return;
        }

        const userData = {
            nome: userNameInput.value,
            matricula: userCodeInput.value,
            setor: userSectorSelect.value,
            funcao: userRoleInput ? userRoleInput.value : '',
            observacoes: userNotesTextarea ? userNotesTextarea.value : ''
        };

        // Verificar se editando ou adicionando
        const url = editUserId !== null ? `/api/usuarios/${editUserId}` : '/api/usuarios';
        const method = editUserId !== null ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(userData)
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.erro || `Erro ao salvar usuário: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                // Recarregar dados atualizados do servidor
                loadUsers();

                // Ocultar o formulário
                const userFormContainer = document.getElementById('userFormContainer');
                if (userFormContainer) {
                    userFormContainer.style.display = 'none';
                }

                alert(data.mensagem || "Usuário salvo com sucesso!");
            })
            .catch(error => {
                console.error('Erro ao salvar usuário:', error);
                alert(error.message);
            });
    }

    // Sobrescrever a função deleteUser para verificar permissão novamente
    function deleteUser(userId) {
        // Verificar se tem permissão para manipular usuários
        if (!temPermissaoEspecial) {
            alert('Você não tem permissão para excluir colaboradores. Apenas o usuário com matrícula MA201990 pode realizar esta ação.');
            return;
        }

        fetch(`/api/usuarios/${userId}`, {
            method: 'DELETE'
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.erro || `Erro ao excluir usuário: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                // Recarregar dados atualizados do servidor
                loadUsers();
                renderUsersTable();
                alert(data.mensagem || "Usuário excluído com sucesso!");
            })
            .catch(error => {
                console.error('Erro ao excluir usuário:', error);
                alert(error.message);
            });
    }

    // Função para verificação adicional nas rotas de API
    function verificarApiPermissoes() {
        // Isso adiciona um interceptor nas requisições para as rotas de API
        const originalFetch = window.fetch;
        window.fetch = function (url, options) {
            // Se for uma operação de manipulação de usuários
            if (url.includes('/api/usuarios') &&
                options &&
                (options.method === 'POST' || options.method === 'PUT' || options.method === 'DELETE')) {

                // Verificar se tem permissão
                if (!temPermissaoEspecial) {
                    console.error("Tentativa de acessar API restrita sem permissão");
                    return Promise.reject(new Error("Você não tem permissão para realizar esta ação"));
                }
            }

            // Prosseguir normalmente com outras requisições
            return originalFetch.apply(this, arguments);
        };
    }

    // Inicializar a verificação de API
    document.addEventListener('DOMContentLoaded', function () {
        verificarApiPermissoes();
    });
</script>

// Coloque este script no final do seu arquivo index.html
// para ajudar a depurar problemas de permissão

<script>
    // Função para teste direto da matrícula
    function testarMatriculaEspecial() {
        fetch('/api/session/user')
            .then(response => response.json())
            .then(data => {
                console.log("%c=== DIAGNÓSTICO DE PERMISSÃO ===", "color: blue; font-weight: bold");
                console.log("ID do usuário: " + data.id);
                console.log("Nome: " + data.nome);
                console.log("Matrícula: " + data.matricula);

                // Verificação exata da matrícula
                const matriculaCorreta = data.matricula === 'MA201990';
                console.log("%cMatrícula é MA201990? " + matriculaCorreta,
                    "color: " + (matriculaCorreta ? "green" : "red") + "; font-weight: bold");

                // Verificar possíveis problemas com espaços em branco
                console.log("Comprimento da matrícula: " + data.matricula.length);
                console.log("Código ASCII de cada caractere:");

                for (let i = 0; i < data.matricula.length; i++) {
                    const char = data.matricula.charAt(i);
                    const code = data.matricula.charCodeAt(i);
                    console.log(`  Posição ${i}: '${char}' (${code})`);
                }

                if (!matriculaCorreta) {
                    console.log("%cSolução: Tente configurar o usuário com a matrícula exata 'MA201990' sem espaços extras.",
                        "color: orange; font-weight: bold");
                }

                console.log("%c=== FIM DO DIAGNÓSTICO ===", "color: blue; font-weight: bold");
            })
            .catch(error => console.error('Erro ao testar matrícula:', error));
    }

    // Executar o teste quando a página carregar
    document.addEventListener('DOMContentLoaded', function () {
        setTimeout(testarMatriculaEspecial, 1000);
    });

    // Evitar conflitos de variáveis
    (function () {
        // Resolver o problema de permissão imediatamente
        window.corrigirPermissao = function () {
            // Forçar a permissão especial para testes
            temPermissaoEspecial = true;
            console.log("Permissão especial ativada manualmente!");

            // Atualizar a interface
            const btnManageUsers = document.getElementById('btnManageUsers');
            if (btnManageUsers) {
                btnManageUsers.style.display = 'flex';
                btnManageUsers.style.position = 'relative';
                btnManageUsers.innerHTML += `<span style="position: absolute; top: -8px; right: -8px; background-color: #e02020; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); border: 2px solid white;"><i class="fas fa-key"></i></span>`;
                btnManageUsers.title = 'Você tem permissão especial para gerenciar colaboradores';
            }

            // Reconfigurar o evento de clique
            btnManageUsers.addEventListener('click', function () {
                // Verificar se o modal já existe
                let usersModal = document.getElementById('usersModal');

                if (!usersModal) {
                    // Criar o modal se não existir
                    usersModal = document.createElement('div');
                    usersModal.id = 'usersModal';
                    usersModal.className = 'modal-backdrop';
                    document.body.appendChild(usersModal);
                }

                usersModal.classList.add('active');
                document.body.style.overflow = 'hidden';

                // Carregar usuários
                loadUsers();
            });
        };

        // Adicionar um botão oculto que permite ativar a permissão
        const btnEmergencia = document.createElement('button');
        btnEmergencia.style.position = 'fixed';
        btnEmergencia.style.bottom = '10px';
        btnEmergencia.style.left = '10px';
        btnEmergencia.style.zIndex = '9999';
        btnEmergencia.style.opacity = '0.2';
        btnEmergencia.style.fontSize = '10px';
        btnEmergencia.textContent = 'Debug';
        btnEmergencia.onclick = function () {
            window.corrigirPermissao();
        };
        document.body.appendChild(btnEmergencia);
    })();
</script>

// Adicionar este script ao final do arquivo index.html

<script>
    // Função para corrigir a matrícula na sessão
    function corrigirMatriculaSessao() {
        // Primeiro, obter os dados da sessão atual
        fetch('/api/session/user')
            .then(response => response.json())
            .then(data => {
                const matriculaAtual = data.matricula;

                // Se a matrícula atual for MA201990 ou com espaços extras
                if (matriculaAtual &&
                    (matriculaAtual === 'MA201990' || matriculaAtual.trim() === 'MA201990')) {

                    console.log("Detectado usuário com permissão especial!");

                    // Atualizar a variável global
                    temPermissaoEspecial = true;

                    // Forçar a atualização da interface
                    const btnManageUsers = document.getElementById('btnManageUsers');
                    if (btnManageUsers) {
                        console.log("Atualizando botão de gerenciamento...");

                        // Garantir que o botão esteja visível
                        btnManageUsers.style.display = 'flex';
                        btnManageUsers.style.position = 'relative';

                        // Adicionar o indicador visual se ainda não existir
                        if (!document.getElementById('special-indicator')) {
                            const indicator = document.createElement('span');
                            indicator.id = 'special-indicator';
                            indicator.style.position = 'absolute';
                            indicator.style.top = '-8px';
                            indicator.style.right = '-8px';
                            indicator.style.backgroundColor = '#e02020';
                            indicator.style.color = 'white';
                            indicator.style.width = '20px';
                            indicator.style.height = '20px';
                            indicator.style.borderRadius = '50%';
                            indicator.style.display = 'flex';
                            indicator.style.alignItems = 'center';
                            indicator.style.justifyContent = 'center';
                            indicator.style.fontSize = '12px';
                            indicator.style.boxShadow = '0 2px 5px rgba(0, 0, 0, 0.2)';
                            indicator.style.border = '2px solid white';
                            indicator.innerHTML = '<i class="fas fa-key"></i>';
                            indicator.title = 'Você tem permissão especial para gerenciar colaboradores';
                            btnManageUsers.appendChild(indicator);
                        }

                        // Remover e adicionar event listener para garantir que seja o correto
                        const newBtn = btnManageUsers.cloneNode(true);
                        if (btnManageUsers.parentNode) {
                            btnManageUsers.parentNode.replaceChild(newBtn, btnManageUsers);
                        }

                        // Adicionar o novo event listener com comportamento correto
                        newBtn.addEventListener('click', function () {
                            // Se tem permissão, abrir o modal normalmente
                            if (temPermissaoEspecial) {
                                // Abrir o modal de usuários
                                const usersModal = document.getElementById('usersModal');
                                if (usersModal) {
                                    // Renderizar tabela de usuários
                                    renderUsersTable();

                                    // Mostrar modal
                                    usersModal.classList.add('active');
                                    document.body.style.overflow = 'hidden';
                                } else {
                                    console.error("Modal de usuários não encontrado!");
                                }
                            } else {
                                // Se não tem permissão, mostrar aviso
                                exibirAvisoPermissao();
                            }
                        });

                        console.log("Botão atualizado com sucesso!");
                    } else {
                        console.error("Botão 'Gerenciar Colaboradores' não encontrado!");
                    }
                } else {
                    console.log("Usuário atual não tem matrícula especial.");
                    temPermissaoEspecial = false;
                }
            })
            .catch(error => {
                console.error("Erro ao verificar matrícula na sessão:", error);
            });
    }

    // Executar a correção após o carregamento da página
    document.addEventListener('DOMContentLoaded', function () {
        // Aguardar um pouco para garantir que outros scripts já foram executados
        setTimeout(corrigirMatriculaSessao, 1000);

        // Também verificar a cada 3 segundos para garantir
        setInterval(corrigirMatriculaSessao, 3000);
    });

    // Redefinir a função openUsersModal para uso no usuário especial
    function openUsersModal() {
        // Recarregar a lista de usuários
        loadUsers();

        // Mostrar o modal
        const usersModal = document.getElementById('usersModal');
        if (usersModal) {
            usersModal.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Renderizar a tabela de usuários
            renderUsersTable();
        }
    }

    // Redefinir comportamento do modal para usuário especial
    var originalLoadUsers = loadUsers;
    loadUsers = function () {
        if (temPermissaoEspecial) {
            originalLoadUsers();
        } else {
            console.warn("Tentativa de carregar usuários sem permissão");
        }
    };
</script>

// Adicione este script ao final do arquivo index.html

<script>
    // Função para forçar o carregamento e renderização de usuários
    function forcarCarregamentoUsuarios() {
        console.log("Tentando forçar carregamento de usuários...");

        // Função para obter usuários da API
        fetch('/api/usuarios')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro ao carregar usuários: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Dados de usuários carregados:", data);

                // Armazenar os usuários na variável global
                window.users = data;

                // Renderizar a tabela de usuários
                renderizarTabelaUsuarios(data);
            })
            .catch(error => {
                console.error('Erro ao carregar usuários:', error);
            });
    }

    // Função para renderizar a tabela de usuários
    function renderizarTabelaUsuarios(usuarios) {
        console.log("Renderizando tabela de usuários...");

        // Obter o elemento tbody da tabela
        const usersTableBody = document.getElementById('usersTableBody');
        if (!usersTableBody) {
            console.error("Elemento 'usersTableBody' não encontrado!");
            return;
        }

        // Limpar a tabela
        usersTableBody.innerHTML = '';

        // Verificar se há usuários
        if (!usuarios || usuarios.length === 0) {
            console.log("Nenhum usuário para exibir.");

            // Adicionar uma linha indicando que não há usuários
            const row = document.createElement('tr');
            row.innerHTML = `
            <td colspan="4" style="text-align: center; padding: 20px;">
                Nenhum colaborador encontrado. Clique em "Adicionar Colaborador" para cadastrar um novo.
            </td>
        `;
            usersTableBody.appendChild(row);
            return;
        }

        // Adicionar cada usuário à tabela
        usuarios.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
            <td>${user.nome || '-'}</td>
            <td>${user.matricula || '-'}</td>
            <td>${user.setor || '-'}</td>
            <td>
                <div class="actions">
                    <button class="btn-icon btn-edit-user" data-id="${user.id}"><i class="fas fa-pen"></i></button>
                    <button class="btn-icon btn-delete-user" data-id="${user.id}"><i class="fas fa-trash"></i></button>
                </div>
            </td>
        `;

            usersTableBody.appendChild(row);
        });

        // Adicionar eventos aos botões de ação
        document.querySelectorAll('.btn-edit-user').forEach(btn => {
            btn.addEventListener('click', () => {
                const userId = parseInt(btn.dataset.id);
                console.log("Clique no botão editar usuário:", userId);
                openEditUserForm(userId);
            });
        });

        document.querySelectorAll('.btn-delete-user').forEach(btn => {
            btn.addEventListener('click', () => {
                const userId = parseInt(btn.dataset.id);
                console.log("Clique no botão excluir usuário:", userId);
                if (confirm('Tem certeza que deseja remover este colaborador?')) {
                    deleteUser(userId);
                }
            });
        });

        console.log("Tabela de usuários renderizada com sucesso!");
    }

    // Substituir a renderUsersTable original por nossa nova função
    window.renderUsersTable = function () {
        forcarCarregamentoUsuarios();
    };

    // Modificar a função openUsersModal para garantir que os usuários sejam carregados
    window.openUsersModal_original = window.openUsersModal;
    window.openUsersModal = function () {
        console.log("Abrindo modal de usuários...");

        // Mostrar o modal
        const usersModal = document.getElementById('usersModal');
        if (usersModal) {
            usersModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        } else {
            console.error("Modal 'usersModal' não encontrado!");
            return;
        }

        // Ocultar o formulário
        const userFormContainer = document.getElementById('userFormContainer');
        if (userFormContainer) {
            userFormContainer.style.display = 'none';
        }

        // Carregar e renderizar os usuários
        forcarCarregamentoUsuarios();
    };

    // Adicionar botão de adicionar colaborador
    document.addEventListener('DOMContentLoaded', function () {
        // Verificar se o botão já existe
        const btnAddUser = document.getElementById('btnAddUser');
        if (btnAddUser) {
            // Configurar evento de clique
            btnAddUser.addEventListener('click', function () {
                console.log("Clique no botão adicionar usuário");
                openAddUserForm();
            });
        } else {
            console.warn("Botão 'btnAddUser' não encontrado!");
        }

        // Ajustar a função para abrir o formulário de adição
        window.openAddUserForm = function () {
            console.log("Abrindo formulário para adicionar usuário...");

            // Indicar que estamos adicionando, não editando
            window.editUserId = null;

            // Obter elementos do formulário
            const userFormTitle = document.getElementById('userFormTitle');
            const userFormContainer = document.getElementById('userFormContainer');
            const userForm = document.getElementById('userForm');

            if (userFormTitle) userFormTitle.textContent = 'Adicionar Colaborador';
            if (userForm) userForm.reset();
            if (userFormContainer) userFormContainer.style.display = 'block';
        };

        // Ajustar a função para abrir o formulário de edição
        window.openEditUserForm = function (userId) {
            console.log("Abrindo formulário para editar usuário:", userId);

            // Armazenar o ID do usuário que está sendo editado
            window.editUserId = userId;

            // Obter o usuário pelo ID
            const user = window.users.find(u => u.id === userId);
            if (!user) {
                console.error("Usuário não encontrado:", userId);
                return;
            }

            // Obter elementos do formulário
            const userFormTitle = document.getElementById('userFormTitle');
            const userNameInput = document.getElementById('userName');
            const userCodeInput = document.getElementById('userCode');
            const userSectorSelect = document.getElementById('userSector');
            const userRoleInput = document.getElementById('userRole');
            const userNotesTextarea = document.getElementById('userNotes');
            const userFormContainer = document.getElementById('userFormContainer');

            // Preencher o formulário com os dados do usuário
            if (userFormTitle) userFormTitle.textContent = `Editar Colaborador: ${user.nome}`;
            if (userNameInput) userNameInput.value = user.nome || '';
            if (userCodeInput) userCodeInput.value = user.matricula || '';
            if (userSectorSelect) userSectorSelect.value = user.setor || '';
            if (userRoleInput) userRoleInput.value = user.funcao || '';
            if (userNotesTextarea) userNotesTextarea.value = user.observacoes || '';

            // Mostrar o formulário
            if (userFormContainer) userFormContainer.style.display = 'block';
        };
    });

    // Adicionar evento para o botão de salvar usuário
    document.addEventListener('DOMContentLoaded', function () {
        const saveUserBtn = document.getElementById('saveUser');
        if (saveUserBtn) {
            saveUserBtn.addEventListener('click', function () {
                console.log("Clique no botão salvar usuário");
                saveUser();
            });
        }

        const cancelUserFormBtn = document.getElementById('cancelUserForm');
        if (cancelUserFormBtn) {
            cancelUserFormBtn.addEventListener('click', function () {
                console.log("Clique no botão cancelar formulário");
                const userFormContainer = document.getElementById('userFormContainer');
                if (userFormContainer) userFormContainer.style.display = 'none';
            });
        }

        // Redefinir a função saveUser
        window.saveUser = function () {
            console.log("Salvando usuário...");

            // Obter valores do formulário
            const userNameInput = document.getElementById('userName');
            const userCodeInput = document.getElementById('userCode');
            const userSectorSelect = document.getElementById('userSector');
            const userRoleInput = document.getElementById('userRole');
            const userNotesTextarea = document.getElementById('userNotes');

            if (!userNameInput || !userCodeInput || !userSectorSelect) {
                console.error("Elementos do formulário não encontrados");
                return;
            }

            // Verificar se os campos obrigatórios estão preenchidos
            if (!userNameInput.value || !userCodeInput.value || !userSectorSelect.value) {
                alert("Por favor, preencha todos os campos obrigatórios!");
                return;
            }

            // Dados do usuário
            const userData = {
                nome: userNameInput.value,
                matricula: userCodeInput.value,
                setor: userSectorSelect.value,
                funcao: userRoleInput ? userRoleInput.value : '',
                observacoes: userNotesTextarea ? userNotesTextarea.value : ''
            };

            // Determinar se é adição ou edição
            const isEdit = window.editUserId !== null;
            const url = isEdit ? `/api/usuarios/${window.editUserId}` : '/api/usuarios';
            const method = isEdit ? 'PUT' : 'POST';

            console.log(`${isEdit ? 'Atualizando' : 'Adicionando'} usuário:`, userData);

            // Fazer a requisição para a API
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userData)
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.erro || `Erro ao salvar usuário: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Resposta do servidor:", data);

                    // Recarregar a lista de usuários
                    forcarCarregamentoUsuarios();

                    // Ocultar o formulário
                    const userFormContainer = document.getElementById('userFormContainer');
                    if (userFormContainer) {
                        userFormContainer.style.display = 'none';
                    }

                    // Mostrar mensagem de sucesso
                    alert(data.mensagem || "Usuário salvo com sucesso!");
                })
                .catch(error => {
                    console.error('Erro ao salvar usuário:', error);
                    alert(`Erro ao salvar usuário: ${error.message}`);
                });
        };

        // Redefinir a função deleteUser
        window.deleteUser = function (userId) {
            console.log("Excluindo usuário:", userId);

            // Fazer a requisição para a API
            fetch(`/api/usuarios/${userId}`, {
                method: 'DELETE'
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.erro || `Erro ao excluir usuário: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Resposta do servidor:", data);

                    // Recarregar a lista de usuários
                    forcarCarregamentoUsuarios();

                    // Mostrar mensagem de sucesso
                    alert(data.mensagem || "Usuário excluído com sucesso!");
                })
                .catch(error => {
                    console.error('Erro ao excluir usuário:', error);
                    alert(`Erro ao excluir usuário: ${error.message}`);
                });
        };

        // Executar o carregamento inicial de usuários quando o modal for aberto
        const btnManageUsers = document.getElementById('btnManageUsers');
        if (btnManageUsers) {
            btnManageUsers.addEventListener('click', function () {
                if (window.temPermissaoEspecial) {
                    console.log("Clique no botão gerenciar usuários (com permissão)");
                    openUsersModal();
                } else {
                    console.log("Clique no botão gerenciar usuários (sem permissão)");
                    exibirAvisoPermissao();
                }
            });
        }
    });

    // Forçar o botão a aparecer para usuário com a matrícula especial
    document.addEventListener('DOMContentLoaded', function () {
        fetch('/api/session/user')
            .then(response => response.json())
            .then(data => {
                console.log("Informações do usuário:", data);

                if (data.matricula === 'MA201990') {
                    console.log("Usuário com permissão especial detectado!");
                    window.temPermissaoEspecial = true;

                    const btnManageUsers = document.getElementById('btnManageUsers');
                    if (btnManageUsers) {
                        btnManageUsers.style.display = 'flex';
                        console.log("Botão de gerenciar colaboradores configurado para usuário especial");
                    }
                }
            })
            .catch(error => console.error('Erro ao verificar usuário:', error));
    });
</script>

// Adicione este script para garantir que o botão de adicionar colaborador funcione corretamente

<script>
    // Garantir que o botão de adicionar colaborador esteja visível e funcionando
    function configurarBotaoAdicionarColaborador() {
        console.log("Configurando botão de adicionar colaborador...");

        // Verificar se o botão já existe
        const btnAddUser = document.getElementById('btnAddUser');
        if (!btnAddUser) {
            console.warn("Botão 'btnAddUser' não encontrado. Tentando criar...");

            // Verificar se o contêiner de botões existe
            const modalBody = document.querySelector('#usersModal .modal-body');
            if (modalBody) {
                // Criar o botão se não existir
                const btnContainer = document.createElement('div');
                btnContainer.className = 'form-group';
                btnContainer.style.marginBottom = '20px';

                const addBtn = document.createElement('button');
                addBtn.id = 'btnAddUser';
                addBtn.className = 'btn btn-primary';
                addBtn.innerHTML = '<i class="fas fa-plus"></i> <span>Adicionar Colaborador</span>';

                // Adicionar evento de clique
                addBtn.addEventListener('click', function () {
                    console.log("Clique no botão adicionar usuário (criado dinamicamente)");
                    openAddUserForm();
                });

                btnContainer.appendChild(addBtn);

                // Inserir no início do modal-body
                modalBody.insertBefore(btnContainer, modalBody.firstChild);

                console.log("Botão de adicionar colaborador criado com sucesso!");
            } else {
                console.error("Contêiner para o botão não encontrado!");
            }
        } else {
            console.log("Botão 'btnAddUser' encontrado, configurando evento.");

            // Remover eventos antigos
            const newBtn = btnAddUser.cloneNode(true);
            btnAddUser.parentNode.replaceChild(newBtn, btnAddUser);

            // Adicionar novo evento
            newBtn.addEventListener('click', function () {
                console.log("Clique no botão adicionar usuário");
                openAddUserForm();
            });
        }
    }

    // Modificar a abertura do modal para garantir que o botão seja configurado
    const originalOpenUsersModal = window.openUsersModal;
    window.openUsersModal = function () {
        // Chamar a implementação original primeiro
        if (originalOpenUsersModal) {
            originalOpenUsersModal();
        } else {
            console.warn("Função original openUsersModal não encontrada!");

            // Implementação alternativa
            const usersModal = document.getElementById('usersModal');
            if (usersModal) {
                usersModal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            // Ocultar o formulário
            const userFormContainer = document.getElementById('userFormContainer');
            if (userFormContainer) {
                userFormContainer.style.display = 'none';
            }

            // Forçar carregamento de usuários
            if (typeof forcarCarregamentoUsuarios === 'function') {
                forcarCarregamentoUsuarios();
            }
        }

        // Garantir que o botão de adicionar esteja configurado
        setTimeout(configurarBotaoAdicionarColaborador, 100);
    };

    // Executar quando o documento estiver pronto
    document.addEventListener('DOMContentLoaded', function () {
        // Adicionar um observador para detectar quando o modal é aberto
        const observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
                if (mutation.type === 'attributes' &&
                    mutation.attributeName === 'class' &&
                    mutation.target.id === 'usersModal' &&
                    mutation.target.classList.contains('active')) {

                    console.log("Modal de usuários aberto detectado!");
                    configurarBotaoAdicionarColaborador();
                }
            });
        });

        // Configurar o observador para o modal
        const usersModal = document.getElementById('usersModal');
        if (usersModal) {
            observer.observe(usersModal, { attributes: true });
        }
    });
</script>

// Adicione este script para garantir que o formulário de adição/edição de usuários funcione corretamente

<script>
    // Função para verificar e criar o formulário de usuário se ele não existir
    function garantirFormularioUsuario() {
        console.log("Verificando formulário de usuário...");

        // Verificar se o contêiner do formulário existe
        let userFormContainer = document.getElementById('userFormContainer');

        if (!userFormContainer) {
            console.warn("Contêiner do formulário não encontrado. Criando...");

            // Obter o corpo do modal
            const modalBody = document.querySelector('#usersModal .modal-body');
            if (!modalBody) {
                console.error("Modal body não encontrado!");
                return;
            }

            // Criar o contêiner do formulário
            userFormContainer = document.createElement('div');
            userFormContainer.id = 'userFormContainer';
            userFormContainer.style.display = 'none';
            userFormContainer.style.borderTop = '1px solid #e9ecef';
            userFormContainer.style.paddingTop = '20px';

            // HTML do formulário
            userFormContainer.innerHTML = `
            <h4 id="userFormTitle">Adicionar Colaborador</h4>
            <form id="userForm">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="userName">Nome Completo</label>
                            <input type="text" class="form-control" id="userName" placeholder="Nome do colaborador" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="userCode">Matrícula</label>
                            <input type="text" class="form-control" id="userCode" placeholder="Ex: MA12345" required>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="userSector">Setor</label>
                            <select class="form-control" id="userSector" required>
                                <option value="">Selecione um setor</option>
                                <option value="Expedição">Expedição</option>
                                <option value="Armazenamento">Armazenamento</option>
                                <option value="Separação">Separação</option>
                                <option value="Conferência">Conferência</option>
                                <option value="TI">TI</option>
                                <option value="Pcp">Pcp</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="userRole">Função</label>
                            <input type="text" class="form-control" id="userRole" placeholder="Ex: Operador, Supervisor">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="userNotes">Observações</label>
                    <textarea class="form-control" id="userNotes" rows="2" placeholder="Observações adicionais"></textarea>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-outline" id="cancelUserForm">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveUser">Salvar</button>
                </div>
            </form>
        `;

            // Adicionar o formulário ao modal
            modalBody.appendChild(userFormContainer);

            console.log("Formulário de usuário criado com sucesso!");

            // Adicionar eventos aos botões
            const cancelUserFormBtn = document.getElementById('cancelUserForm');
            if (cancelUserFormBtn) {
                cancelUserFormBtn.addEventListener('click', function () {
                    userFormContainer.style.display = 'none';
                });
            }

            const saveUserBtn = document.getElementById('saveUser');
            if (saveUserBtn) {
                saveUserBtn.addEventListener('click', function () {
                    window.saveUser();
                });
            }
        } else {
            console.log("Formulário de usuário encontrado.");
        }
    }

    // Modificar as funções de abertura de formulário
    function openAddUserForm() {
        console.log("Abrindo formulário para adicionar usuário...");

        // Garantir que o formulário existe
        garantirFormularioUsuario();

        // Resetar o ID de edição
        window.editUserId = null;

        // Atualizar o título
        const userFormTitle = document.getElementById('userFormTitle');
        if (userFormTitle) {
            userFormTitle.textContent = 'Adicionar Colaborador';
        }

        // Limpar o formulário
        const userForm = document.getElementById('userForm');
        if (userForm) {
            userForm.reset();
        }

        // Mostrar o formulário
        const userFormContainer = document.getElementById('userFormContainer');
        if (userFormContainer) {
            userFormContainer.style.display = 'block';
        }
    }

    function openEditUserForm(userId) {
        console.log("Abrindo formulário para editar usuário:", userId);

        // Garantir que o formulário existe
        garantirFormularioUsuario();

        // Definir o ID do usuário sendo editado
        window.editUserId = userId;

        // Buscar o usuário
        const usuario = window.users.find(u => u.id === userId);
        if (!usuario) {
            console.error("Usuário não encontrado:", userId);
            return;
        }

        // Atualizar o título
        const userFormTitle = document.getElementById('userFormTitle');
        if (userFormTitle) {
            userFormTitle.textContent = `Editar Colaborador: ${usuario.nome}`;
        }

        // Preencher o formulário
        const userNameInput = document.getElementById('userName');
        const userCodeInput = document.getElementById('userCode');
        const userSectorSelect = document.getElementById('userSector');
        const userRoleInput = document.getElementById('userRole');
        const userNotesTextarea = document.getElementById('userNotes');

        if (userNameInput) userNameInput.value = usuario.nome || '';
        if (userCodeInput) userCodeInput.value = usuario.matricula || '';
        if (userSectorSelect) userSectorSelect.value = usuario.setor || '';
        if (userRoleInput) userRoleInput.value = usuario.funcao || '';
        if (userNotesTextarea) userNotesTextarea.value = usuario.observacoes || '';

        // Mostrar o formulário
        const userFormContainer = document.getElementById('userFormContainer');
        if (userFormContainer) {
            userFormContainer.style.display = 'block';
        }
    }

    // Sobrescrever as funções globais
    window.openAddUserForm = openAddUserForm;
    window.openEditUserForm = openEditUserForm;

    // Inicialização
    document.addEventListener('DOMContentLoaded', function () {
        // Garantir que o formulário existe quando o documento estiver pronto
        setTimeout(garantirFormularioUsuario, 500);
    });
</script>


// Adicione este script diretamente no arquivo HTML para manter os botões de gerenciar colaboradores

<script>
    // Solução definitiva para garantir que os botões permaneçam visíveis

    // Função para manter elementos protegidos sempre visíveis
    function protegerElementos() {
        // Lista de seletores de elementos importantes que devem permanecer visíveis
        const elementosProtegidos = [
            {
                seletor: '#btnManageUsers',             // Botão principal Gerenciar Colaboradores
                display: 'flex',                        // Estilo de exibição desejado
                condicao: () => verificarMatriculaEspecial() // Mostrar apenas se matrícula for especial
            },
            {
                seletor: '#btnAddUser',                // Botão Adicionar Colaborador 
                display: 'block',                       // Estilo de exibição desejado
                condicao: () => true                    // Mostrar sempre dentro do modal
            },
            {
                seletor: '.btn-edit-user',             // Botões de editar usuário
                display: 'flex',                        // Estilo de exibição desejado 
                condicao: () => true                    // Mostrar sempre
            },
            {
                seletor: '.btn-delete-user',           // Botões de excluir usuário
                display: 'flex',                        // Estilo de exibição desejado
                condicao: () => true                    // Mostrar sempre
            }
        ];

        // Verificar e ajustar a visibilidade periodicamente
        setInterval(() => {
            // Para cada tipo de elemento protegido
            elementosProtegidos.forEach(config => {
                // Verificar se a condição para exibição é atendida
                if (config.condicao()) {
                    // Buscar todos os elementos pelo seletor
                    const elementos = document.querySelectorAll(config.seletor);

                    // Para cada elemento encontrado
                    elementos.forEach(elemento => {
                        // Se estiver oculto, torná-lo visível
                        if (elemento.style.display === 'none') {
                            console.log(`Restaurando visibilidade de ${config.seletor}`);
                            elemento.style.display = config.display;
                        }
                    });
                }
            });
        }, 100); // Verificar a cada 100ms
    }

    // Função para verificar se o usuário atual tem a matrícula especial
    function verificarMatriculaEspecial() {
        // Variável global criada anteriormente
        if (typeof window.temPermissaoEspecial !== 'undefined') {
            return window.temPermissaoEspecial;
        }

        // Se não houver variável global, verificar a sessão
        const sessionData = sessionStorage.getItem('permissaoEspecial');
        if (sessionData) {
            return sessionData === 'true';
        }

        // Por padrão, assumir que não tem permissão
        return false;
    }

    // Função para verificar a matrícula do usuário ativamente
    function verificarEArmazenarPermissao() {
        fetch('/api/session/user')
            .then(response => response.json())
            .then(data => {
                // Verificar se a matrícula é a especial
                const isEspecial = data.matricula === 'MA201990';

                // Armazenar na variável global
                window.temPermissaoEspecial = isEspecial;

                // Armazenar na sessionStorage para persistência
                sessionStorage.setItem('permissaoEspecial', isEspecial.toString());

                console.log("Permissão especial verificada:", isEspecial);

                // Atualizar a interface imediatamente
                const btnManageUsers = document.getElementById('btnManageUsers');
                if (btnManageUsers && isEspecial) {
                    btnManageUsers.style.display = 'flex';

                    // Adicionar indicador visual
                    if (!document.getElementById('special-indicator')) {
                        const indicator = document.createElement('span');
                        indicator.id = 'special-indicator';
                        indicator.style.position = 'absolute';
                        indicator.style.top = '-8px';
                        indicator.style.right = '-8px';
                        indicator.style.backgroundColor = '#e02020';
                        indicator.style.color = 'white';
                        indicator.style.width = '20px';
                        indicator.style.height = '20px';
                        indicator.style.borderRadius = '50%';
                        indicator.style.display = 'flex';
                        indicator.style.alignItems = 'center';
                        indicator.style.justifyContent = 'center';
                        indicator.style.fontSize = '12px';
                        indicator.style.boxShadow = '0 2px 5px rgba(0, 0, 0, 0.2)';
                        indicator.style.border = '2px solid white';
                        indicator.innerHTML = '<i class="fas fa-key"></i>';
                        indicator.title = 'Você tem permissão especial para gerenciar colaboradores';
                        btnManageUsers.style.position = 'relative';
                        btnManageUsers.appendChild(indicator);
                    }
                }
            })
            .catch(error => {
                console.error("Erro ao verificar sessão:", error);
            });
    }

    // Criação de uma MutationObserver para monitorar mudanças no DOM
    function configurarObservadorDOM() {
        // Criar o observador
        const observer = new MutationObserver(function (mutations) {
            // Para cada mutação ocorrida
            mutations.forEach(function (mutation) {
                // Se for uma mudança de atributo de estilo
                if (mutation.type === 'attributes' &&
                    mutation.attributeName === 'style' &&
                    mutation.target.style.display === 'none') {

                    // Verificar se é um elemento protegido
                    const elementoProtegido = [
                        { seletor: '#btnManageUsers', display: 'flex', condicao: verificarMatriculaEspecial },
                        { seletor: '#btnAddUser', display: 'block', condicao: () => true },
                        { seletor: '.btn-edit-user', display: 'flex', condicao: () => true },
                        { seletor: '.btn-delete-user', display: 'flex', condicao: () => true }
                    ].find(el =>
                        mutation.target.matches(el.seletor) && el.condicao()
                    );

                    // Se for um elemento protegido que atende à condição
                    if (elementoProtegido) {
                        console.log(`Bloqueada tentativa de ocultar ${elementoProtegido.seletor}`);
                        mutation.target.style.display = elementoProtegido.display;
                    }
                }

                // Se o modal de usuários foi aberto
                if (mutation.type === 'attributes' &&
                    mutation.attributeName === 'class' &&
                    mutation.target.id === 'usersModal' &&
                    mutation.target.classList.contains('active')) {

                    // Forçar o carregamento de colaboradores
                    console.log("Modal de usuários aberto - carregando colaboradores");
                    if (typeof window.forcarCarregamentoUsuarios === 'function') {
                        window.forcarCarregamentoUsuarios();
                    } else {
                        // Se a função não existir, tentar carregamento direto
                        fetch('/api/usuarios')
                            .then(response => response.json())
                            .then(data => {
                                window.users = data;

                                // Renderizar usuários se a função estiver disponível
                                if (typeof window.renderizarTabelaUsuarios === 'function') {
                                    window.renderizarTabelaUsuarios(data);
                                } else if (typeof window.renderUsersTable === 'function') {
                                    window.renderUsersTable();
                                }
                            })
                            .catch(error => console.error('Erro ao carregar usuários:', error));
                    }
                }
            });
        });

        // Configurar o que observar - todo o corpo do documento
        observer.observe(document.body, {
            attributes: true,
            childList: true,
            subtree: true,
            attributeFilter: ['style', 'class']
        });

        console.log("Observador DOM configurado com sucesso!");
    }

    // Função para manipular o comportamento do botão Gerenciar Colaboradores
    function configurarBotaoGerenciarColaboradores() {
        const btnManageUsers = document.getElementById('btnManageUsers');

        if (btnManageUsers) {
            // Mostrar para todos
            btnManageUsers.style.display = 'flex';

            // Substituir o botão para remover listeners antigos
            const newBtn = btnManageUsers.cloneNode(true);
            btnManageUsers.parentNode.replaceChild(newBtn, btnManageUsers);

            // Adicionar novo listener
            newBtn.addEventListener('click', function (e) {
                e.preventDefault();

                if (verificarMatriculaEspecial()) {
                    // Tem permissão, abrir o modal
                    const usersModal = document.getElementById('usersModal');
                    if (usersModal) {
                        usersModal.classList.add('active');
                        document.body.style.overflow = 'hidden';

                        // Forçar carregamento de usuários
                        if (typeof window.forcarCarregamentoUsuarios === 'function') {
                            window.forcarCarregamentoUsuarios();
                        }
                    }
                } else {
                    // Não tem permissão, mostrar aviso
                    if (typeof window.exibirAvisoPermissao === 'function') {
                        window.exibirAvisoPermissao();
                    } else {
                        // Implementação alternativa se a função não existir
                        alert('Você não tem permissão para gerenciar colaboradores. Apenas o usuário com matrícula MA201990 pode realizar esta ação.');
                    }
                }
            });
        } else {
            console.error("Botão 'Gerenciar Colaboradores' não encontrado!");
        }
    }

    // Inicialização quando o documento estiver pronto
    document.addEventListener('DOMContentLoaded', function () {
        console.log("Inicializando proteção para botões...");

        // Verificar permissão
        verificarEArmazenarPermissao();

        // Configurar observador para mudanças no DOM
        configurarObservadorDOM();

        // Proteger elementos importantes
        protegerElementos();

        // Configurar o botão Gerenciar Colaboradores
        setTimeout(configurarBotaoGerenciarColaboradores, 500);

        console.log("Proteção para botões inicializada com sucesso!");
    });

    // Manter verificação periódica de permissão
    setInterval(verificarEArmazenarPermissao, 5000); // A cada 5 segundos
</script>

// Esta é uma implementação direta e completa do modal de colaboradores
// Adicione este script ao final do arquivo index.html, antes do </body>

<script>
    // Função para criar ou atualizar o modal de colaboradores
    function criarModalColaboradores() {
        console.log("Criando/atualizando modal de colaboradores...");

        // Verificar se o modal já existe
        let modalExistente = document.getElementById('usersModal');

        // Se já existir, removê-lo para criar um novo
        if (modalExistente) {
            modalExistente.parentNode.removeChild(modalExistente);
        }

        // Criar o novo modal
        const modal = document.createElement('div');
        modal.id = 'usersModal';
        modal.className = 'modal-backdrop';

        // HTML do modal
        modal.innerHTML = `
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Gerenciar Colaboradores</h3>
                <button class="modal-close" id="closeUsersModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" id="btnAddUser">
                        <i class="fas fa-plus"></i>
                        <span>Adicionar Colaborador</span>
                    </button>
                </div>
                
                <table style="width: 100%; margin-bottom: 20px;">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Matrícula</th>
                            <th>Setor</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- Os usuários serão inseridos via JavaScript -->
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 20px;">
                                Carregando colaboradores...
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <div id="userFormContainer" style="display: none; border-top: 1px solid #e9ecef; padding-top: 20px;">
                    <h4 id="userFormTitle">Adicionar Colaborador</h4>
                    <form id="userForm">
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="userName">Nome Completo</label>
                                    <input type="text" class="form-control" id="userName" placeholder="Nome do colaborador" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="userCode">Matrícula</label>
                                    <input type="text" class="form-control" id="userCode" placeholder="Ex: MA12345" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="userSector">Setor</label>
                                    <select class="form-control" id="userSector" required>
                                        <option value="">Selecione um setor</option>
                                        <option value="Expedição">Expedição</option>
                                        <option value="Armazenamento">Armazenamento</option>
                                        <option value="Separação">Separação</option>
                                        <option value="Conferência">Conferência</option>
                                        <option value="TI">TI</option>
                                        <option value="Pcp">Pcp</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label class="form-label" for="userRole">Função</label>
                                    <input type="text" class="form-control" id="userRole" placeholder="Ex: Operador, Supervisor">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="userNotes">Observações</label>
                            <textarea class="form-control" id="userNotes" rows="2" placeholder="Observações adicionais"></textarea>
                        </div>
                        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                            <button type="button" class="btn btn-outline" id="cancelUserForm">Cancelar</button>
                            <button type="button" class="btn btn-primary" id="saveUser">Salvar</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelUsersModal">Fechar</button>
            </div>
        </div>
    `;

        // Adicionar o modal ao body
        document.body.appendChild(modal);

        // Configurar evento de clique para fechar o modal
        document.getElementById('closeUsersModal').addEventListener('click', function () {
            modal.classList.remove('active');
            document.body.style.overflow = '';
        });

        // Configurar evento de clique para o botão "Fechar"
        document.getElementById('cancelUsersModal').addEventListener('click', function () {
            modal.classList.remove('active');
            document.body.style.overflow = '';
        });

        // Configurar evento de clique para o botão "Adicionar Colaborador"
        document.getElementById('btnAddUser').addEventListener('click', function () {
            // Resetar ID de edição
            window.editUserId = null;

            // Limpar o formulário
            document.getElementById('userForm').reset();

            // Atualizar o título
            document.getElementById('userFormTitle').textContent = 'Adicionar Colaborador';

            // Mostrar o formulário
            document.getElementById('userFormContainer').style.display = 'block';
        });

        // Configurar evento de clique para o botão "Cancelar" do formulário
        document.getElementById('cancelUserForm').addEventListener('click', function () {
            // Ocultar o formulário
            document.getElementById('userFormContainer').style.display = 'none';
        });

        // Configurar evento de clique para o botão "Salvar"
        document.getElementById('saveUser').addEventListener('click', function () {
            salvarUsuario();
        });

        console.log("Modal de colaboradores criado/atualizado com sucesso!");

        // Retornar o modal para uso posterior
        return modal;
    }

    // Função para abrir o modal de colaboradores
    function abrirModalColaboradores() {
        console.log("Abrindo modal de colaboradores...");

        // Verificar permissão
        fetch('/api/session/user')
            .then(response => response.json())
            .then(data => {
                const temPermissao = data.matricula === 'MA201990';

                if (temPermissao) {
                    // Tem permissão, abrir o modal
                    console.log("Usuário tem permissão, abrindo modal...");

                    // Garantir que o modal existe
                    let modal = document.getElementById('usersModal');
                    if (!modal) {
                        modal = criarModalColaboradores();
                    }

                    // Mostrar o modal
                    modal.classList.add('active');
                    document.body.style.overflow = 'hidden';

                    // Ocultar o formulário
                    const userFormContainer = document.getElementById('userFormContainer');
                    if (userFormContainer) {
                        userFormContainer.style.display = 'none';
                    }

                    // Carregar colaboradores
                    carregarColaboradores();
                } else {
                    // Não tem permissão, mostrar aviso
                    console.log("Usuário não tem permissão, exibindo aviso...");
                    exibirAvisoPermissaoNegada();
                }
            })
            .catch(error => {
                console.error("Erro ao verificar permissão:", error);
                exibirAvisoPermissaoNegada();
            });
    }

    // Função para carregar colaboradores
    function carregarColaboradores() {
        console.log("Carregando colaboradores...");

        // Obter o elemento tbody da tabela
        const usersTableBody = document.getElementById('usersTableBody');
        if (!usersTableBody) {
            console.error("Tabela de usuários não encontrada!");
            return;
        }

        // Exibir mensagem de carregamento
        usersTableBody.innerHTML = `
        <tr>
            <td colspan="4" style="text-align: center; padding: 20px;">
                <i class="fas fa-spinner fa-spin" style="margin-right: 10px;"></i> Carregando colaboradores...
            </td>
        </tr>
    `;

        // Buscar colaboradores da API
        fetch('/api/usuarios')
            .then(response => response.json())
            .then(data => {
                // Armazenar usuários globalmente
                window.users = data;

                // Limpar tabela
                usersTableBody.innerHTML = '';

                // Verificar se há usuários
                if (!data || data.length === 0) {
                    usersTableBody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 20px;">
                            Nenhum colaborador encontrado. Clique em "Adicionar Colaborador" para cadastrar um novo.
                        </td>
                    </tr>
                `;
                    return;
                }

                // Adicionar cada usuário à tabela
                data.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${user.nome || '-'}</td>
                    <td>${user.matricula || '-'}</td>
                    <td>${user.setor || '-'}</td>
                    <td>
                        <div class="actions">
                            <button class="btn-icon btn-edit-user" data-id="${user.id}"><i class="fas fa-pen"></i></button>
                            <button class="btn-icon btn-delete-user" data-id="${user.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;

                    usersTableBody.appendChild(row);
                });

                // Adicionar eventos aos botões de ação
                document.querySelectorAll('.btn-edit-user').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const userId = parseInt(this.dataset.id);
                        editarUsuario(userId);
                    });
                });

                document.querySelectorAll('.btn-delete-user').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const userId = parseInt(this.dataset.id);
                        if (confirm('Tem certeza que deseja remover este colaborador?')) {
                            excluirUsuario(userId);
                        }
                    });
                });

                console.log("Colaboradores carregados com sucesso!");
            })
            .catch(error => {
                console.error("Erro ao carregar colaboradores:", error);

                // Exibir mensagem de erro
                usersTableBody.innerHTML = `
                <tr>
                    <td colspan="4" style="text-align: center; padding: 20px; color: #dc3545;">
                        <i class="fas fa-exclamation-circle" style="margin-right: 10px;"></i> 
                        Erro ao carregar colaboradores. Tente novamente.
                    </td>
                </tr>
            `;
            });
    }

    // Função para editar usuário
    function editarUsuario(userId) {
        console.log("Editando usuário:", userId);

        // Armazenar ID do usuário sendo editado
        window.editUserId = userId;

        // Encontrar o usuário pelo ID
        const usuario = window.users.find(u => u.id === userId);
        if (!usuario) {
            console.error("Usuário não encontrado:", userId);
            alert("Usuário não encontrado!");
            return;
        }

        // Preencher o formulário
        const userFormTitle = document.getElementById('userFormTitle');
        const userName = document.getElementById('userName');
        const userCode = document.getElementById('userCode');
        const userSector = document.getElementById('userSector');
        const userRole = document.getElementById('userRole');
        const userNotes = document.getElementById('userNotes');
        const userFormContainer = document.getElementById('userFormContainer');

        if (userFormTitle) userFormTitle.textContent = `Editar Colaborador: ${usuario.nome}`;
        if (userName) userName.value = usuario.nome || '';
        if (userCode) userCode.value = usuario.matricula || '';
        if (userSector) userSector.value = usuario.setor || '';
        if (userRole) userRole.value = usuario.funcao || '';
        if (userNotes) userNotes.value = usuario.observacoes || '';

        // Mostrar o formulário
        if (userFormContainer) userFormContainer.style.display = 'block';
    }

    // Função para salvar usuário
    function salvarUsuario() {
        console.log("Salvando usuário...");

        // Obter valores do formulário
        const userName = document.getElementById('userName').value;
        const userCode = document.getElementById('userCode').value;
        const userSector = document.getElementById('userSector').value;
        const userRole = document.getElementById('userRole').value;
        const userNotes = document.getElementById('userNotes').value;

        // Validar campos obrigatórios
        if (!userName || !userCode || !userSector) {
            alert("Por favor, preencha todos os campos obrigatórios!");
            return;
        }

        // Dados do usuário
        const userData = {
            nome: userName,
            matricula: userCode,
            setor: userSector,
            funcao: userRole || '',
            observacoes: userNotes || ''
        };

        // Verificar se é edição ou adição
        const isEdit = window.editUserId !== null;
        const url = isEdit ? `/api/usuarios/${window.editUserId}` : '/api/usuarios';
        const method = isEdit ? 'PUT' : 'POST';

        // Fazer a requisição para a API
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(userData)
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.erro || `Erro ao salvar usuário: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                // Exibir mensagem de sucesso
                alert(data.mensagem || "Colaborador salvo com sucesso!");

                // Ocultar formulário
                const userFormContainer = document.getElementById('userFormContainer');
                if (userFormContainer) {
                    userFormContainer.style.display = 'none';
                }

                // Recarregar lista de colaboradores
                carregarColaboradores();
            })
            .catch(error => {
                console.error("Erro ao salvar usuário:", error);
                alert(`Erro ao salvar colaborador: ${error.message}`);
            });
    }

    // Função para excluir usuário
    function excluirUsuario(userId) {
        console.log("Excluindo usuário:", userId);

        // Fazer a requisição para a API
        fetch(`/api/usuarios/${userId}`, {
            method: 'DELETE'
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.erro || `Erro ao excluir usuário: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                // Exibir mensagem de sucesso
                alert(data.mensagem || "Colaborador excluído com sucesso!");

                // Recarregar lista de colaboradores
                carregarColaboradores();
            })
            .catch(error => {
                console.error("Erro ao excluir usuário:", error);
                alert(`Erro ao excluir colaborador: ${error.message}`);
            });
    }

    // Função para exibir aviso de permissão negada
    function exibirAvisoPermissaoNegada() {
        // Verificar se já existe um aviso na tela
        if (document.getElementById('avisoPermissao')) {
            return;
        }

        // Criar o aviso
        const avisoContainer = document.createElement('div');
        avisoContainer.className = 'modal-backdrop active';
        avisoContainer.id = 'avisoPermissao';
        avisoContainer.style.zIndex = '2000';

        avisoContainer.innerHTML = `
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header" style="background-color: #dc3545; color: white;">
                <h3 class="modal-title">Permissão Negada</h3>
                <button class="modal-close" id="fecharAviso">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <i class="fas fa-lock" style="font-size: 48px; color: #dc3545; margin-bottom: 15px;"></i>
                    <p>Você não tem permissão para gerenciar colaboradores.</p>
                    <p style="margin-top: 10px;"><strong>Apenas o usuário com matrícula MA201990 pode realizar esta ação.</strong></p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="entendidoBtn" style="background-color: #dc3545; border-color: #dc3545;">Entendido</button>
            </div>
        </div>
    `;

        // Adicionar ao body
        document.body.appendChild(avisoContainer);

        // Adicionar eventos aos botões
        document.getElementById('fecharAviso').addEventListener('click', function () {
            document.body.removeChild(avisoContainer);
        });

        document.getElementById('entendidoBtn').addEventListener('click', function () {
            document.body.removeChild(avisoContainer);
        });
    }

    // Substituir o botão "Gerenciar Colaboradores" por um que use nossa implementação
    function configurarBotaoGerenciarColaboradores() {
        console.log("Configurando botão Gerenciar Colaboradores com nova implementação...");

        // Garantir que o modal existe
        criarModalColaboradores();

        // Encontrar o botão
        const btnManageUsers = document.getElementById('btnManageUsers');
        if (btnManageUsers) {
            // Substituir o botão para remover eventos antigos
            const newBtn = btnManageUsers.cloneNode(true);
            if (btnManageUsers.parentNode) {
                btnManageUsers.parentNode.replaceChild(newBtn, btnManageUsers);
            }

            // Deixar o botão visível para todos
            newBtn.style.display = 'flex';

            // Adicionar evento de clique
            newBtn.addEventListener('click', function (e) {
                e.preventDefault();
                abrirModalColaboradores();
            });

            console.log("Botão Gerenciar Colaboradores configurado com sucesso!");
        } else {
            console.error("Botão 'btnManageUsers' não encontrado!");
        }
    }

    // Inicialização
    document.addEventListener('DOMContentLoaded', function () {
        console.log("Inicializando implementação direta do modal de colaboradores...");

        // Garantir que o modal existe
        criarModalColaboradores();

        // Configurar o botão
        setTimeout(configurarBotaoGerenciarColaboradores, 500);

        // Adicionar classe customizada para injetar estilos
        const style = document.createElement('style');
        style.textContent = `
        .btn-icon {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            transition: all 0.3s ease;
            background: none;
            border: none;
            cursor: pointer;
            margin: 0 3px;
        }
        
        .btn-edit-user {
            background-color: rgba(255, 193, 7, 0.1);
            color: var(--warning);
        }
        
        .btn-edit-user:hover {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-delete-user {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger);
        }
        
        .btn-delete-user:hover {
            background-color: var(--danger);
            color: white;
        }
    `;
        document.head.appendChild(style);

        console.log("Implementação direta inicializada com sucesso!");
    });
</script>

// Adicione este script ao final do arquivo index.html

<script>
    // Função para carregar os usuários no dropdown
    function carregarUsuariosDropdown() {
        console.log("Carregando usuários para o dropdown...");

        // Obter o elemento dropdown
        const userSelect = document.getElementById('collectorUser');

        if (!userSelect) {
            console.error("Dropdown de usuários não encontrado!");
            return;
        }

        // Limpar opções existentes, mantendo apenas a primeira (se houver)
        while (userSelect.options.length > 1) {
            userSelect.remove(1);
        }

        // Adicionar texto de carregamento
        const loadingOption = document.createElement('option');
        loadingOption.textContent = "Carregando usuários...";
        loadingOption.disabled = true;
        loadingOption.selected = true;
        userSelect.appendChild(loadingOption);

        // Buscar usuários da API
        fetch('/api/usuarios')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro ao carregar usuários: ${response.status}`);
                }
                return response.json();
            })
            .then(usuarios => {
                console.log("Usuários carregados:", usuarios);

                // Remover opção de carregamento
                userSelect.remove(userSelect.options.length - 1);

                // Verificar se há usuários
                if (!usuarios || usuarios.length === 0) {
                    const noUsersOption = document.createElement('option');
                    noUsersOption.textContent = "Nenhum usuário encontrado";
                    noUsersOption.disabled = true;
                    userSelect.appendChild(noUsersOption);
                    return;
                }

                // Adicionar cada usuário ao dropdown
                usuarios.forEach(usuario => {
                    const option = document.createElement('option');
                    option.value = usuario.nome;
                    option.textContent = usuario.nome;
                    userSelect.appendChild(option);
                });

                console.log("Dropdown de usuários atualizado com sucesso!");
            })
            .catch(error => {
                console.error("Erro ao carregar usuários:", error);

                // Remover opção de carregamento
                userSelect.remove(userSelect.options.length - 1);

                // Adicionar opção de erro
                const errorOption = document.createElement('option');
                errorOption.textContent = "Erro ao carregar usuários";
                errorOption.disabled = true;
                userSelect.appendChild(errorOption);
            });
    }

    // Função para monitorar a abertura do modal de coletores
    function monitorarModalColetores() {
        console.log("Configurando monitoramento do modal de coletores...");

        // Botão para adicionar coletor
        const btnAddCollector = document.getElementById('btnAddCollector');
        if (btnAddCollector) {
            // Substituir o botão para remover eventos antigos
            const newBtn = btnAddCollector.cloneNode(true);
            if (btnAddCollector.parentNode) {
                btnAddCollector.parentNode.replaceChild(newBtn, btnAddCollector);
            }

            // Adicionar novo evento de clique
            newBtn.addEventListener('click', function () {
                console.log("Clique no botão adicionar coletor detectado!");

                // Carregar usuários no dropdown
                setTimeout(carregarUsuariosDropdown, 100);
            });

            console.log("Botão de adicionar coletor configurado!");
        } else {
            console.warn("Botão de adicionar coletor não encontrado!");
        }

        // Observar botões de editar coletor
        document.addEventListener('click', function (event) {
            // Verificar se o clique foi em um botão de editar coletor
            if (event.target.closest('.btn-edit') ||
                (event.target.tagName === 'I' && event.target.closest('.btn-edit'))) {
                console.log("Clique no botão editar coletor detectado!");

                // Carregar usuários no dropdown
                setTimeout(carregarUsuariosDropdown, 100);
            }
        });

        // Observar mudanças no DOM para detectar quando o modal é aberto
        const observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
                if (mutation.type === 'attributes' &&
                    mutation.attributeName === 'class' &&
                    mutation.target.id === 'collectorModal' &&
                    mutation.target.classList.contains('active')) {

                    console.log("Modal de coletores aberto detectado via MutationObserver!");

                    // Carregar usuários no dropdown
                    setTimeout(carregarUsuariosDropdown, 100);
                }
            });
        });

        // Configurar a observação
        const collectorModal = document.getElementById('collectorModal');
        if (collectorModal) {
            observer.observe(collectorModal, {
                attributes: true,
                attributeFilter: ['class']
            });
            console.log("Observador do modal de coletores configurado!");
        } else {
            console.warn("Modal de coletores não encontrado para observação!");
        }

        console.log("Monitoramento do modal de coletores configurado com sucesso!");
    }

    // Sobrescrever a função openAddModal para garantir que os usuários sejam carregados
    function sobrescreverOpenAddModal() {
        console.log("Sobrescrevendo função openAddModal...");

        // Armazenar a referência à função original
        const originalOpenAddModal = window.openAddModal;

        // Sobrescrever a função
        window.openAddModal = function () {
            console.log("Função openAddModal sobrescrita executada!");

            // Chamar a função original primeiro
            if (typeof originalOpenAddModal === 'function') {
                originalOpenAddModal();
            }

            // Em seguida, carregar os usuários no dropdown
            setTimeout(carregarUsuariosDropdown, 100);
        };

        console.log("Função openAddModal sobrescrita com sucesso!");
    }

    // Sobrescrever a função openEditModal para garantir que os usuários sejam carregados
    function sobrescreverOpenEditModal() {
        console.log("Sobrescrevendo função openEditModal...");

        // Armazenar a referência à função original
        const originalOpenEditModal = window.openEditModal;

        // Sobrescrever a função
        window.openEditModal = function (collectorId) {
            console.log("Função openEditModal sobrescrita executada para coletor:", collectorId);

            // Chamar a função original primeiro
            if (typeof originalOpenEditModal === 'function') {
                originalOpenEditModal(collectorId);
            }

            // Em seguida, carregar os usuários no dropdown
            setTimeout(carregarUsuariosDropdown, 100);
        };

        console.log("Função openEditModal sobrescrita com sucesso!");
    }

    // Carregar usuários mesmo quando a página é carregada
    document.addEventListener('DOMContentLoaded', function () {
        console.log("Inicializando correção do dropdown de usuários...");

        // Monitorar o modal de coletores
        monitorarModalColetores();

        // Sobrescrever as funções de abertura de modal
        sobrescreverOpenAddModal();
        sobrescreverOpenEditModal();

        // Tentar carregar usuários imediatamente se o modal estiver aberto
        const collectorModal = document.getElementById('collectorModal');
        if (collectorModal && collectorModal.classList.contains('active')) {
            console.log("Modal de coletores já está aberto, carregando usuários...");
            setTimeout(carregarUsuariosDropdown, 100);
        }

        console.log("Inicialização da correção do dropdown de usuários concluída!");
    });
</script>

// Adicione este script ao final do arquivo index.html

<script>
    // Abordagem direta e robusta para garantir que o dropdown de usuários seja sempre carregado

    // Função para buscar usuários da API e preencher o dropdown
    function preencherDropdownUsuarios() {
        // Verificar se o dropdown existe
        const userSelect = document.getElementById('collectorUser');
        if (!userSelect) {
            console.error("Elemento 'collectorUser' não encontrado!");
            return;
        }

        console.log("Preenchendo dropdown de usuários...");

        // Limpar opções existentes, mantendo apenas a primeira (vazia)
        while (userSelect.options.length > 1) {
            userSelect.remove(1);
        }

        // Fazer requisição para a API
        fetch('/api/usuarios')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro na resposta: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(`${data.length} usuários carregados:`, data);

                // Adicionar cada usuário ao dropdown
                data.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.nome;
                    option.textContent = user.nome;
                    userSelect.appendChild(option);
                });

                console.log("Dropdown de usuários preenchido com sucesso!");
            })
            .catch(error => {
                console.error("Erro ao carregar usuários:", error);

                // Adicionar opção de erro para indicar o problema
                const errorOption = document.createElement('option');
                errorOption.textContent = "Erro ao carregar usuários";
                errorOption.disabled = true;
                userSelect.appendChild(errorOption);
            });
    }

    // Função para verificar e monitorar o modal de coletores
    function monitorarModalColetores() {
        // Observer para monitorar mudanças na visibilidade do modal
        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                // Se o modal foi aberto (classe 'active' adicionada)
                if (mutation.type === 'attributes' &&
                    mutation.attributeName === 'class' &&
                    mutation.target.classList.contains('active')) {

                    console.log("Modal de coletores aberto detectado!");

                    // Preencher o dropdown com usuários
                    setTimeout(preencherDropdownUsuarios, 200);
                }
            });
        });

        // Configurar o observador para o modal
        const collectorModal = document.getElementById('collectorModal');
        if (collectorModal) {
            observer.observe(collectorModal, {
                attributes: true,
                attributeFilter: ['class']
            });
            console.log("Observer configurado para o modal de coletores");
        } else {
            console.error("Modal 'collectorModal' não encontrado!");
        }
    }

    // Sobrescrever as funções de abertura do modal
    function sobrescreverFuncoesDeAbertura() {
        // Sobrescrever a função openModal (geralmente chamada por openAddModal e openEditModal)
        if (typeof window.openModal === 'function') {
            const originalOpenModal = window.openModal;
            window.openModal = function () {
                // Chamar a função original
                originalOpenModal.apply(this, arguments);

                // Depois carregar os usuários no dropdown
                setTimeout(preencherDropdownUsuarios, 200);
            };
            console.log("Função openModal sobrescrita com sucesso!");
        }

        // Sobrescrever a função openAddModal diretamente
        if (typeof window.openAddModal === 'function') {
            const originalOpenAddModal = window.openAddModal;
            window.openAddModal = function () {
                // Chamar a função original
                originalOpenAddModal.apply(this, arguments);

                // Depois carregar os usuários no dropdown
                setTimeout(preencherDropdownUsuarios, 200);
            };
            console.log("Função openAddModal sobrescrita com sucesso!");
        }

        // Sobrescrever a função openEditModal diretamente
        if (typeof window.openEditModal === 'function') {
            const originalOpenEditModal = window.openEditModal;
            window.openEditModal = function (collectorId) {
                // Chamar a função original
                originalOpenEditModal.apply(this, arguments);

                // Depois carregar os usuários no dropdown
                setTimeout(preencherDropdownUsuarios, 200);
            };
            console.log("Função openEditModal sobrescrita com sucesso!");
        }
    }

    // Configurar eventos de clique nos botões que abrem o modal
    function configurarEventosBotoes() {
        // Botão para adicionar coletor
        document.addEventListener('click', function (event) {
            // Verificar se o clique foi no botão de adicionar coletor
            if (event.target.id === 'btnAddCollector' ||
                (event.target.parentElement && event.target.parentElement.id === 'btnAddCollector')) {

                console.log("Clique no botão adicionar coletor detectado!");
                // Aguardar abertura do modal e carregar usuários
                setTimeout(preencherDropdownUsuarios, 300);
            }

            // Verificar se o clique foi em um botão de editar coletor
            if (event.target.classList.contains('btn-edit') ||
                (event.target.parentElement && event.target.parentElement.classList.contains('btn-edit'))) {

                console.log("Clique no botão editar coletor detectado!");
                // Aguardar abertura do modal e carregar usuários
                setTimeout(preencherDropdownUsuarios, 300);
            }
        });
    }

    // Verificação periódica para garantir que o dropdown esteja preenchido quando necessário
    function iniciarVerificacaoPeriodica() {
        setInterval(() => {
            // Verificar se o modal está aberto
            const collectorModal = document.getElementById('collectorModal');
            if (collectorModal && collectorModal.classList.contains('active')) {
                // Verificar se o dropdown está vazio
                const userSelect = document.getElementById('collectorUser');
                if (userSelect && userSelect.options.length <= 1) {
                    console.log("Modal aberto com dropdown vazio detectado, preenchendo...");
                    preencherDropdownUsuarios();
                }
            }
        }, 1000); // Verificar a cada 1 segundo
    }

    // Inicializar todas as funcionalidades quando o documento estiver pronto
    document.addEventListener('DOMContentLoaded', function () {
        console.log("Inicializando carregamento de usuários para dropdown...");

        // Sobrescrever funções de abertura do modal
        sobrescreverFuncoesDeAbertura();

        // Configurar eventos de clique nos botões
        configurarEventosBotoes();

        // Configurar monitoramento do modal
        monitorarModalColetores();

        // Iniciar verificação periódica
        iniciarVerificacaoPeriodica();

        // Verificar se o modal já está aberto e carregar usuários
        const collectorModal = document.getElementById('collectorModal');
        if (collectorModal && collectorModal.classList.contains('active')) {
            console.log("Modal já está aberto na inicialização, carregando usuários...");
            preencherDropdownUsuarios();
        }

        console.log("Inicialização concluída!");
    });

    // Último recurso - injetar a função no objeto window para garantir acesso global
    window.forcarCarregamentoUsuariosDropdown = preencherDropdownUsuarios;
</script>

// Adicione este script ao final do arquivo index.html

<script>
    // Função para carregar usuários sem duplicação
    function carregarUsuariosSemDuplicacao() {
        console.log("Carregando usuários sem duplicação...");

        // Obter o elemento select
        const userSelect = document.getElementById('collectorUser');
        if (!userSelect) {
            console.error("Elemento 'collectorUser' não encontrado!");
            return;
        }

        // Limpar completamente o dropdown antes de adicionar novos itens
        // Mantendo apenas a primeira opção (que geralmente é 'Selecione um usuário')
        while (userSelect.options.length > 1) {
            userSelect.remove(1);
        }

        // Adicionar indicador de carregamento
        const loadingOption = document.createElement('option');
        loadingOption.textContent = "Carregando usuários...";
        loadingOption.disabled = true;
        userSelect.appendChild(loadingOption);

        // Buscar usuários da API
        fetch('/api/usuarios')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro ao carregar usuários: ${response.status}`);
                }
                return response.json();
            })
            .then(usuarios => {
                console.log(`${usuarios.length} usuários carregados:`, usuarios);

                // Remover a opção de carregamento
                for (let i = 0; i < userSelect.options.length; i++) {
                    if (userSelect.options[i].text === "Carregando usuários...") {
                        userSelect.remove(i);
                        break;
                    }
                }

                // Verificar se há usuários
                if (!usuarios || usuarios.length === 0) {
                    const emptyOption = document.createElement('option');
                    emptyOption.textContent = "Nenhum usuário encontrado";
                    emptyOption.disabled = true;
                    userSelect.appendChild(emptyOption);
                    return;
                }

                // Usar um Set para controlar os nomes já adicionados e evitar duplicação
                const nomesAdicionados = new Set();

                // Adicionar cada usuário ao dropdown, evitando duplicações
                usuarios.forEach(usuario => {
                    // Verificar se este nome já foi adicionado
                    if (!nomesAdicionados.has(usuario.nome)) {
                        // Adicionar ao Set para controle
                        nomesAdicionados.add(usuario.nome);

                        // Criar e adicionar a opção ao dropdown
                        const option = document.createElement('option');
                        option.value = usuario.nome;
                        option.textContent = usuario.nome;
                        userSelect.appendChild(option);
                    }
                });

                console.log(`${nomesAdicionados.size} usuários únicos adicionados ao dropdown.`);
            })
            .catch(error => {
                console.error("Erro ao carregar usuários:", error);

                // Remover a opção de carregamento se existir
                for (let i = 0; i < userSelect.options.length; i++) {
                    if (userSelect.options[i].text === "Carregando usuários...") {
                        userSelect.remove(i);
                        break;
                    }
                }

                // Adicionar uma opção de erro
                const errorOption = document.createElement('option');
                errorOption.textContent = "Erro ao carregar usuários";
                errorOption.disabled = true;
                userSelect.appendChild(errorOption);
            });
    }

    // Sobrescrever as funções de abertura de modal para carregar usuários
    function sobrescreverFuncoesModal() {
        // 1. Sobrescrever a função openAddModal
        if (typeof window.openAddModal === 'function') {
            const originalOpenAddModal = window.openAddModal;
            window.openAddModal = function () {
                // Chamar a função original
                originalOpenAddModal.apply(this, arguments);

                // Carregar usuários sem duplicação
                setTimeout(carregarUsuariosSemDuplicacao, 200);
            };
            console.log("Função openAddModal sobrescrita.");
        }

        // 2. Sobrescrever a função openEditModal
        if (typeof window.openEditModal === 'function') {
            const originalOpenEditModal = window.openEditModal;
            window.openEditModal = function (collectorId) {
                // Chamar a função original
                originalOpenEditModal.apply(this, arguments);

                // Carregar usuários sem duplicação
                setTimeout(carregarUsuariosSemDuplicacao, 200);
            };
            console.log("Função openEditModal sobrescrita.");
        }

        // 3. Sobrescrever a função openModal (se existir)
        if (typeof window.openModal === 'function') {
            const originalOpenModal = window.openModal;
            window.openModal = function () {
                // Chamar a função original
                originalOpenModal.apply(this, arguments);

                // Carregar usuários sem duplicação
                setTimeout(carregarUsuariosSemDuplicacao, 200);
            };
            console.log("Função openModal sobrescrita.");
        }
    }

    // Monitorar o modal de coletores usando MutationObserver
    function monitorarModalColetores() {
        // Criar o observer
        const observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
                if (mutation.type === 'attributes' &&
                    mutation.attributeName === 'class' &&
                    mutation.target.id === 'collectorModal' &&
                    mutation.target.classList.contains('active')) {

                    console.log("Modal de coletores aberto detectado!");
                    setTimeout(carregarUsuariosSemDuplicacao, 200);
                }
            });
        });

        // Configurar o observer
        const collectorModal = document.getElementById('collectorModal');
        if (collectorModal) {
            observer.observe(collectorModal, {
                attributes: true,
                attributeFilter: ['class']
            });
            console.log("Observer configurado para o modal de coletores.");

            // Verificar se o modal já está aberto
            if (collectorModal.classList.contains('active')) {
                console.log("Modal de coletores já está aberto!");
                setTimeout(carregarUsuariosSemDuplicacao, 200);
            }
        } else {
            console.warn("Modal de coletores não encontrado para monitoramento!");
        }
    }

    // Configurar eventos de clique nos botões de abertura do modal
    function configurarEventosBotoes() {
        // Botão de adicionar coletor
        const btnAddCollector = document.getElementById('btnAddCollector');
        if (btnAddCollector) {
            // Remover eventos existentes
            const newBtn = btnAddCollector.cloneNode(true);
            btnAddCollector.parentNode.replaceChild(newBtn, btnAddCollector);

            // Adicionar novo evento
            newBtn.addEventListener('click', function () {
                console.log("Clique no botão adicionar coletor detectado!");
                setTimeout(carregarUsuariosSemDuplicacao, 300);
            });
            console.log("Eventos do botão 'Adicionar Coletor' configurados.");
        }

        // Botões de editar coletor (eventos delegados)
        document.addEventListener('click', function (event) {
            if (event.target.closest('.btn-edit') ||
                (event.target.tagName === 'I' && event.target.closest('.btn-edit'))) {
                console.log("Clique em botão editar coletor detectado!");
                setTimeout(carregarUsuariosSemDuplicacao, 300);
            }
        });
        console.log("Eventos para botões 'Editar' configurados.");
    }

    // Verificação periódica do dropdown
    function iniciarVerificacaoPeriodica() {
        setInterval(() => {
            const modal = document.getElementById('collectorModal');
            if (modal && modal.classList.contains('active')) {
                const userSelect = document.getElementById('collectorUser');
                if (userSelect) {
                    // Verificar se o dropdown está vazio
                    if (userSelect.options.length <= 1) {
                        console.log("Dropdown vazio detectado em modal aberto. Carregando usuários...");
                        carregarUsuariosSemDuplicacao();
                    }
                    // Verificar se há duplicados
                    else {
                        const nomes = new Set();
                        let temDuplicados = false;

                        // Verificar a partir do índice 1 (pulando o primeiro item que é o placeholder)
                        for (let i = 1; i < userSelect.options.length; i++) {
                            const nome = userSelect.options[i].text;
                            if (nomes.has(nome)) {
                                temDuplicados = true;
                                break;
                            }
                            nomes.add(nome);
                        }

                        if (temDuplicados) {
                            console.log("Duplicações detectadas no dropdown. Recarregando...");
                            carregarUsuariosSemDuplicacao();
                        }
                    }
                }
            }
        }, 2000); // Verificar a cada 2 segundos

        console.log("Verificação periódica iniciada.");
    }

    // Inicializar tudo quando o documento estiver pronto
    document.addEventListener('DOMContentLoaded', function () {
        console.log("Inicializando correção para dropdown de usuários...");

        // Sobrescrever funções de abertura do modal
        sobrescreverFuncoesModal();

        // Configurar monitoramento do modal
        monitorarModalColetores();

        // Configurar eventos de botões
        configurarEventosBotoes();

        // Iniciar verificação periódica
        iniciarVerificacaoPeriodica();

        // Disponibilizar a função globalmente (para debugging via console)
        window.carregarUsuariosSemDuplicacao = carregarUsuariosSemDuplicacao;

        console.log("Correção para dropdown de usuários inicializada com sucesso!");
    });
</script>

// Adicione este script ao final do arquivo index.html para corrigir o botão salvar

<script>
    // Função para corrigir o botão salvar no modal de coletores
    function corrigirBotaoSalvar() {
        console.log("Configurando correção para o botão salvar...");

        // Verificar se o botão existe
        const btnSalvar = document.getElementById('saveCollector');
        if (!btnSalvar) {
            console.error("Botão 'saveCollector' não encontrado!");
            return;
        }

        console.log("Botão salvar encontrado, reconfigurando eventos...");

        // Remover todos os eventos existentes
        const newBtn = btnSalvar.cloneNode(true);
        btnSalvar.parentNode.replaceChild(newBtn, btnSalvar);

        // Adicionar o evento de clique diretamente
        newBtn.addEventListener('click', function (e) {
            e.preventDefault();
            console.log("Botão salvar clicado!");

            // Verificar se a função saveCollector existe
            if (typeof window.saveCollector === 'function') {
                // Chamar a função original
                window.saveCollector();
            } else {
                // Implementação alternativa se a função não existir
                salvarColetor();
            }
        });

        console.log("Botão salvar reconfigurado com sucesso!");
    }

    // Implementação alternativa da função saveCollector
    function salvarColetor() {
        console.log("Executando implementação alternativa de salvarColetor...");

        // Verificar se o formulário é válido
        const form = document.getElementById('collectorForm');
        if (form && !form.checkValidity()) {
            form.reportValidity();
            return;
        }

        // Obter valores dos campos
        const id = document.getElementById('collectorId').value;
        const modelo = document.getElementById('collectorModel').value;
        const numero_serie = document.getElementById('collectorSerial').value;
        const usuario = document.getElementById('collectorUser').value;
        const setor = document.getElementById('collectorSector').value;
        const status = document.getElementById('collectorStatus').value;
        const bateria = parseInt(document.getElementById('collectorBattery').value, 10);
        const tempo_uso = document.getElementById('collectorUsageTime').value;
        const problema = document.getElementById('collectorIssue') ? document.getElementById('collectorIssue').value : '';
        const observacoes = document.getElementById('collectorNotes') ? document.getElementById('collectorNotes').value : '';

        // Verificar campos obrigatórios
        if (!id || !numero_serie || !status) {
            alert("Por favor, preencha todos os campos obrigatórios!");
            return;
        }

        // Preparar dados do coletor
        const collectorData = {
            id: id,
            modelo: modelo,
            numero_serie: numero_serie,
            usuario: usuario,
            setor: setor,
            status: status,
            bateria: bateria,
            tempo_uso: tempo_uso,
            problema: problema,
            observacoes: observacoes
        };

        // Verificar se é edição (ID não editável) ou adição
        const isEdit = document.getElementById('collectorId').readOnly;
        const url = isEdit ? `/api/coletores/${id}` : '/api/coletores';
        const method = isEdit ? 'PUT' : 'POST';

        // Enviar requisição para a API
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(collectorData)
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.erro || `Erro ao salvar coletor: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                // Exibir mensagem de sucesso
                alert(data.mensagem || "Coletor salvo com sucesso!");

                // Fechar o modal
                const modal = document.getElementById('collectorModal');
                if (modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }

                // Recarregar a lista de coletores
                if (typeof window.loadCollectors === 'function') {
                    window.loadCollectors();
                } else {
                    // Recarregar a página se não houver função de recarga
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error("Erro ao salvar coletor:", error);
                alert(`Erro ao salvar coletor: ${error.message}`);
            });
    }

    // Configura a correção quando o modal é aberto
    function monitorarAberturaDoBotao() {
        // Observer para detectar quando o modal é aberto
        const observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
                if (mutation.type === 'attributes' &&
                    mutation.attributeName === 'class' &&
                    mutation.target.id === 'collectorModal' &&
                    mutation.target.classList.contains('active')) {

                    console.log("Modal de coletores aberto, corrigindo botão salvar...");
                    setTimeout(corrigirBotaoSalvar, 200);
                }
            });
        });

        // Configurar o observer
        const collectorModal = document.getElementById('collectorModal');
        if (collectorModal) {
            observer.observe(collectorModal, {
                attributes: true,
                attributeFilter: ['class']
            });
            console.log("Observer configurado para o modal de coletores");

            // Verificar se o modal já está aberto
            if (collectorModal.classList.contains('active')) {
                console.log("Modal já está aberto, corrigindo botão salvar...");
                setTimeout(corrigirBotaoSalvar, 200);
            }
        }
    }

    // Configura a correção quando algum botão de abertura do modal é clicado
    function configurarEventosBotoes() {
        // Botão de adicionar coletor
        const btnAddCollector = document.getElementById('btnAddCollector');
        if (btnAddCollector) {
            btnAddCollector.addEventListener('click', function () {
                console.log("Clique no botão adicionar coletor, corrigindo botão salvar...");
                setTimeout(corrigirBotaoSalvar, 300);
            });
        }

        // Botões de editar coletor (via delegação de eventos)
        document.addEventListener('click', function (event) {
            const isEditButton = event.target.classList.contains('btn-edit') ||
                (event.target.parentElement && event.target.parentElement.classList.contains('btn-edit'));

            if (isEditButton) {
                console.log("Clique no botão editar coletor, corrigindo botão salvar...");
                setTimeout(corrigirBotaoSalvar, 300);
            }
        });
    }

    // Inicialização quando o documento estiver pronto
    document.addEventListener('DOMContentLoaded', function () {
        console.log("Inicializando correção para o botão salvar...");

        // Configurar monitoramento do modal
        monitorarAberturaDoBotao();

        // Configurar eventos para botões que abrem o modal
        configurarEventosBotoes();

        // Verificar se o modal já está aberto e corrigir o botão
        const collectorModal = document.getElementById('collectorModal');
        if (collectorModal && collectorModal.classList.contains('active')) {
            console.log("Modal já está aberto na inicialização, corrigindo botão salvar...");
            setTimeout(corrigirBotaoSalvar, 200);
        }

        console.log("Correção para o botão salvar inicializada com sucesso!");
    });
</script>

// Adicione este script ao final do arquivo index.html

<script>
    // Implementação direta do botão salvar - abordagem mais robusta
    (function () {
        console.log("Configurando implementação direta do botão salvar...");

        // Função que será chamada quando o botão salvar for clicado
        function handleButtonClick(event) {
            // Prevenir comportamento padrão do botão
            event.preventDefault();
            event.stopPropagation();

            console.log("Clique no botão salvar interceptado!");

            // Validar o formulário
            const form = document.getElementById('collectorForm');
            if (form && !form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Coletar dados do formulário
            const collectorData = {
                id: document.getElementById('collectorId').value,
                modelo: document.getElementById('collectorModel').value,
                numero_serie: document.getElementById('collectorSerial').value,
                usuario: document.getElementById('collectorUser').value,
                setor: document.getElementById('collectorSector').value,
                status: document.getElementById('collectorStatus').value,
                bateria: parseInt(document.getElementById('collectorBattery').value, 10),
                tempo_uso: document.getElementById('collectorUsageTime').value,
                problema: document.getElementById('collectorIssue') ? document.getElementById('collectorIssue').value : '',
                observacoes: document.getElementById('collectorNotes') ? document.getElementById('collectorNotes').value : ''
            };

            // Determinar se é edição ou adição
            const isEdit = document.getElementById('collectorId').readOnly;
            const url = isEdit ? `/api/coletores/${collectorData.id}` : '/api/coletores';
            const method = isEdit ? 'PUT' : 'POST';

            console.log(`Enviando requisição ${method} para ${url}...`);

            // Enviar dados para a API
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(collectorData)
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.erro || `Erro ao salvar coletor: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Resposta da API:", data);

                    // Exibir mensagem de sucesso
                    alert(data.mensagem || "Coletor salvo com sucesso!");

                    // Fechar o modal
                    const modal = document.getElementById('collectorModal');
                    if (modal) {
                        modal.classList.remove('active');
                        document.body.style.overflow = '';
                    }

                    // Recarregar a lista de coletores
                    if (typeof window.loadCollectors === 'function') {
                        window.loadCollectors();
                    } else if (typeof window.renderCollectorsTable === 'function') {
                        // Se apenas a função de renderização estiver disponível
                        fetch('/api/coletores')
                            .then(response => response.json())
                            .then(data => {
                                window.collectors = data;
                                window.renderCollectorsTable();
                            })
                            .catch(error => console.error("Erro ao recarregar coletores:", error));
                    } else {
                        // Se nenhuma função estiver disponível, recarregar a página
                        window.location.reload();
                    }
                })
                .catch(error => {
                    console.error("Erro ao salvar coletor:", error);
                    alert(`Erro ao salvar coletor: ${error.message}`);
                });
        }

        // Função para adicionar evento de clique ao botão
        function configurarBotaoSalvar() {
            const botaoSalvar = document.getElementById('saveCollector');
            if (!botaoSalvar) {
                console.error("Botão 'saveCollector' não encontrado!");
                return;
            }

            // Remover todos os listeners existentes (forma mais segura)
            const novoBotao = botaoSalvar.cloneNode(true);
            botaoSalvar.parentNode.replaceChild(novoBotao, botaoSalvar);

            // Adicionar novo evento de clique
            novoBotao.addEventListener('click', handleButtonClick);

            // Adicionar também ao evento submit do formulário
            const form = document.getElementById('collectorForm');
            if (form) {
                form.addEventListener('submit', function (event) {
                    event.preventDefault();
                    handleButtonClick(event);
                });
            }

            console.log("Botão salvar configurado com sucesso!");
        }

        // Usar um MutationObserver para detectar quando o modal é aberto
        function monitorarModal() {
            const observer = new MutationObserver(function (mutations) {
                mutations.forEach(function (mutation) {
                    if (mutation.type === 'attributes' &&
                        mutation.attributeName === 'class' &&
                        mutation.target.id === 'collectorModal' &&
                        mutation.target.classList.contains('active')) {

                        console.log("Modal aberto detectado via MutationObserver!");
                        setTimeout(configurarBotaoSalvar, 200);
                    }
                });
            });

            // Configurar o observer para o modal
            const collectorModal = document.getElementById('collectorModal');
            if (collectorModal) {
                observer.observe(collectorModal, {
                    attributes: true,
                    attributeFilter: ['class']
                });

                // Verificar se o modal já está aberto
                if (collectorModal.classList.contains('active')) {
                    console.log("Modal já está aberto na inicialização!");
                    setTimeout(configurarBotaoSalvar, 200);
                }
            } else {
                console.warn("Modal 'collectorModal' não encontrado!");
            }
        }

        // Monitorar cliques nos botões que abrem o modal
        function monitorarBotoesAbertura() {
            // Botão de adicionar coletor
            document.addEventListener('click', function (event) {
                // Verificar se o clique foi no botão adicionar ou em algum elemento dentro dele
                if (event.target.id === 'btnAddCollector' ||
                    (event.target.parentElement && event.target.parentElement.id === 'btnAddCollector')) {

                    console.log("Clique no botão adicionar coletor detectado!");
                    setTimeout(configurarBotaoSalvar, 300);
                }

                // Verificar se o clique foi em um botão editar
                if (event.target.classList.contains('btn-edit') ||
                    (event.target.parentElement && event.target.parentElement.classList.contains('btn-edit'))) {

                    console.log("Clique no botão editar coletor detectado!");
                    setTimeout(configurarBotaoSalvar, 300);
                }
            });
        }

        // Verificar periodicamente se o botão existe e precisa ser configurado
        function verificacaoPeriodica() {
            setInterval(() => {
                const modal = document.getElementById('collectorModal');
                const botaoSalvar = document.getElementById('saveCollector');

                if (modal && modal.classList.contains('active') && botaoSalvar) {
                    // Verificar se o botão já possui nosso evento configurado
                    const temEventoNosso = botaoSalvar.hasAttribute('data-evento-configurado');

                    if (!temEventoNosso) {
                        console.log("Botão salvar sem evento detectado na verificação periódica!");
                        configurarBotaoSalvar();

                        // Marcar o botão como configurado
                        botaoSalvar.setAttribute('data-evento-configurado', 'true');
                    }
                }
            }, 1000);
        }

        // Inicializar quando o documento estiver pronto
        document.addEventListener('DOMContentLoaded', function () {
            console.log("Inicializando implementação direta do botão salvar...");

            // Configurar o monitoramento do modal
            monitorarModal();

            // Monitorar botões que abrem o modal
            monitorarBotoesAbertura();

            // Iniciar verificação periódica
            verificacaoPeriodica();

            console.log("Implementação direta do botão salvar inicializada com sucesso!");
        });
    })();
</script>

// Adicione este script ao arquivo index.html para estilizar os status

<script>
    // Função para estilizar os status de coletores
    function estilizarStatusColetores() {
        console.log("Estilizando status dos coletores...");

        // Adicionar estilos CSS
        const estilos = document.createElement('style');
        estilos.textContent = `
        /* Status "Com problema" em vermelho e piscando */
        .status-warning {
            background-color: rgba(220, 53, 69, 0.1) !important;
            color: #dc3545 !important;
            animation: piscar 1s infinite;
        }
        
        /* Status "Em manutenção" em amarelo */
        .status-error {
            background-color: rgba(255, 193, 7, 0.1) !important;
            color: #ffc107 !important;
        }
        
        /* Animação de piscar */
        @keyframes piscar {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    `;
        document.head.appendChild(estilos);

        // Aplicar estilos aos elementos existentes
        aplicarEstilosStatus();

        // Observer para aplicar estilos em elementos futuros
        const observer = new MutationObserver(function (mutations) {
            aplicarEstilosStatus();
        });

        // Observar mudanças no DOM
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });

        console.log("Estilos para status aplicados com sucesso!");
    }

    // Função para aplicar estilos aos elementos de status
    function aplicarEstilosStatus() {
        // Status "Com problema"
        document.querySelectorAll('.status').forEach(function (elemento) {
            // Verificar texto do elemento
            if (elemento.textContent.trim() === 'Com problema') {
                elemento.classList.add('status-warning');
                elemento.classList.remove('status-error');
            }
            // Status "Em manutenção"
            else if (elemento.textContent.trim() === 'Em manutenção') {
                elemento.classList.add('status-error');
                elemento.classList.remove('status-warning');
            }
        });
    }

    // Inicializar quando o documento estiver pronto
    document.addEventListener('DOMContentLoaded', function () {
        estilizarStatusColetores();
    });
</script>

// Script para remover os comentários de instrução que aparecem na tela

<script>
    // Função para remover os comentários de instrução
    function removerComentariosInstrucao() {
        console.log("Removendo comentários de instrução...");

        // Verificar todos os nós de texto na página
        const observer = new MutationObserver(function (mutations) {
            // Para cada mutação no DOM
            mutations.forEach(function (mutation) {
                // Se foram adicionados nós
                if (mutation.addedNodes.length) {
                    mutation.addedNodes.forEach(function (node) {
                        // Verificar se é um nó de texto
                        if (node.nodeType === Node.TEXT_NODE) {
                            // Verificar se o texto contém instruções
                            if (node.textContent && node.textContent.includes('//Adicione este código') ||
                                node.textContent && node.textContent.includes('// Adicione este script')) {
                                // Remover o nó
                                node.textContent = '';
                            }
                        }
                        // Se é um elemento, verificar seus filhos
                        else if (node.nodeType === Node.ELEMENT_NODE) {
                            // Obter todos os nós de texto dentro do elemento
                            const textos = [];
                            const walker = document.createTreeWalker(
                                node,
                                NodeFilter.SHOW_TEXT,
                                null,
                                false
                            );

                            let nodoTexto;
                            while (nodoTexto = walker.nextNode()) {
                                textos.push(nodoTexto);
                            }

                            // Verificar cada nó de texto
                            textos.forEach(function (texto) {
                                if (texto.textContent && texto.textContent.includes('//Adicione este código') ||
                                    texto.textContent && texto.textContent.includes('// Adicione este script')) {
                                    texto.textContent = '';
                                }
                            });
                        }
                    });
                }
            });

            // Também verificar todos os elementos visíveis
            document.querySelectorAll('*').forEach(function (elemento) {
                // Verificar se o elemento tem texto visível
                if (elemento.childNodes.length > 0) {
                    elemento.childNodes.forEach(function (child) {
                        if (child.nodeType === Node.TEXT_NODE) {
                            if (child.textContent && child.textContent.includes('//Adicione este código') ||
                                child.textContent && child.textContent.includes('// Adicione este script')) {
                                child.textContent = '';
                            }
                        }
                    });
                }
            });
        });

        // Observar mudanças no DOM
        observer.observe(document.body, {
            childList: true,
            subtree: true,
            characterData: true
        });

        // Executar uma verificação inicial
        document.querySelectorAll('*').forEach(function (elemento) {
            // Verificar se o elemento tem texto visível
            if (elemento.childNodes.length > 0) {
                elemento.childNodes.forEach(function (child) {
                    if (child.nodeType === Node.TEXT_NODE) {
                        if (child.textContent && child.textContent.includes('//Adicione este código') ||
                            child.textContent && child.textContent.includes('// Adicione este script')) {
                            child.textContent = '';
                        }
                    }
                });
            }
        });

        console.log("Sistema de remoção de comentários configurado com sucesso!");
    }

    // Inicializar quando o documento estiver pronto
    document.addEventListener('DOMContentLoaded', function () {
        removerComentariosInstrucao();

        // Executar também após um pequeno atraso para pegar elementos carregados dinamicamente
        setTimeout(removerComentariosInstrucao, 1000);
        setTimeout(removerComentariosInstrucao, 3000);
    });
</script>

<script>
    // Solução completa para estilização e remoção de comentários

    (function () {
        // ===== PARTE 1: ESTILIZAR OS STATUS =====

        // Adicionar estilos CSS para os status
        const estilos = document.createElement('style');
        estilos.textContent = `
            /* Status "Com problema" em vermelho e piscando */
            .status-warning, span:contains('Com problema') {
                background-color: rgba(220, 53, 69, 0.1) !important;
                color: #dc3545 !important;
                animation: piscar 1s infinite !important;
                font-weight: bold !important;
            }
            
            /* Status "Em manutenção" em amarelo */
            .status-error, span:contains('Em manutenção') {
                background-color: rgba(255, 193, 7, 0.1) !important;
                color: #ffc107 !important;
                font-weight: bold !important;
            }
            
            /* Animação de piscar */
            @keyframes piscar {
                0% { opacity: 1; }
                50% { opacity: 0.5; }
                100% { opacity: 1; }
            }
        `;
        document.head.appendChild(estilos);

        // Função para estilizar os status
        function estilizarStatus() {
            // Para cada elemento com a classe .status
            document.querySelectorAll('.status').forEach(function (elemento) {
                const texto = elemento.textContent.trim();

                if (texto === 'Com problema') {
                    elemento.classList.add('status-warning');
                    elemento.style.animation = 'piscar 1s infinite';
                    elemento.style.color = '#dc3545';
                    elemento.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
                    elemento.style.fontWeight = 'bold';
                }
                else if (texto === 'Em manutenção') {
                    elemento.classList.add('status-error');
                    elemento.style.color = '#ffc107';
                    elemento.style.backgroundColor = 'rgba(255, 193, 7, 0.1)';
                    elemento.style.fontWeight = 'bold';
                }
            });
        }

        // ===== PARTE 2: REMOVER COMENTÁRIOS DE INSTRUÇÃO =====

        // Função para remover comentários de instrução
        function removerComentarios() {
            // Remover instruções específicas
            const textosInstrucao = [
                "//Adicione este código",
                "// Adicione este script",
                "Adicione este código ao final",
                "Substitua o código de verificação",
                "Coloque este script",
                "Adicione este script ao final",
                "Adicione este script para garantir",
                "Esta é uma implementação direta",
                "// Este script remove",
                "// Esta função configura"
            ];

            // Função para verificar se um nó de texto contém instruções
            function contemInstrucoes(texto) {
                return textosInstrucao.some(instrucao => texto.includes(instrucao));
            }

            // Função recursiva para limpar todos os nós de texto
            function limparNosDeTexto(node) {
                // Se é um nó de texto
                if (node.nodeType === Node.TEXT_NODE) {
                    if (contemInstrucoes(node.textContent)) {
                        node.textContent = '';
                    }
                }
                // Se é um elemento, verificar seus filhos
                else if (node.childNodes) {
                    Array.from(node.childNodes).forEach(limparNosDeTexto);
                }
            }

            // Limpar o body inteiro
            limparNosDeTexto(document.body);
        }

        // ===== INICIALIZAÇÃO E MONITORAMENTO =====

        // Observer para monitorar mudanças no DOM
        const observer = new MutationObserver(function () {
            estilizarStatus();
            removerComentarios();
        });

        // Configurar o observer
        observer.observe(document.body, {
            childList: true,
            subtree: true,
            characterData: true
        });

        // Executar ao carregar a página
        document.addEventListener('DOMContentLoaded', function () {
            estilizarStatus();
            removerComentarios();
        });

        // Também executar agora caso o DOM já esteja carregado
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            estilizarStatus();
            removerComentarios();
        }

        // Executar periodicamente para garantir
        setInterval(function () {
            estilizarStatus();
            removerComentarios();
        }, 1000);
    })();
</script>

<script>
    // Script para adicionar o status "Disponível para Uso" com estilo azul piscando

    (function () {
        // Adicionar estilos CSS para o novo status
        const estilos = document.createElement('style');
        estilos.textContent = `
            /* Status "Disponível para Uso" em azul e piscando */
            .status-disponivel, span:contains('Disponível para Uso') {
                background-color: rgba(0, 123, 255, 0.1) !important;
                color: #0275d8 !important;
                animation: piscar-azul 1s infinite !important;
                font-weight: bold !important;
            }
            
            /* Animação de piscar azul */
            @keyframes piscar-azul {
                0% { opacity: 1; }
                50% { opacity: 0.6; }
                100% { opacity: 1; }
            }
            
            /* Adicionar a opção ao dropdown de status */
            option[value="Disponível para Uso"] {
                color: #0275d8;
                font-weight: bold;
            }
        `;
        document.head.appendChild(estilos);

        // Função para adicionar o novo status ao dropdown
        function adicionarNovoStatus() {
            // Encontrar todos os selects de status
            document.querySelectorAll('select#collectorStatus').forEach(select => {
                // Verificar se a opção já existe
                let opcaoExiste = false;
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value === 'Disponível para Uso') {
                        opcaoExiste = true;
                        break;
                    }
                }

                // Adicionar a opção se não existir
                if (!opcaoExiste) {
                    const opcao = document.createElement('option');
                    opcao.value = 'Disponível para Uso';
                    opcao.textContent = 'Disponível para Uso';

                    // Inserir após a opção "Ativo"
                    let aposAtivo = false;
                    for (let i = 0; i < select.options.length; i++) {
                        if (select.options[i].value === 'Ativo') {
                            aposAtivo = true;
                        } else if (aposAtivo) {
                            select.insertBefore(opcao, select.options[i]);
                            break;
                        }
                    }

                    // Se não encontrou a posição certa, adiciona ao final
                    if (!aposAtivo || select.options.length <= 1) {
                        select.appendChild(opcao);
                    }
                }
            });
        }

        // Função para estilizar os status
        function estilizarStatus() {
            // Para cada elemento com a classe .status
            document.querySelectorAll('.status').forEach(function (elemento) {
                const texto = elemento.textContent.trim();

                if (texto === 'Disponível para Uso') {
                    elemento.classList.add('status-disponivel');
                    elemento.style.animation = 'piscar-azul 1s infinite';
                    elemento.style.color = '#0275d8';
                    elemento.style.backgroundColor = 'rgba(0, 123, 255, 0.1)';
                    elemento.style.fontWeight = 'bold';
                }
            });
        }

        // Observer para monitorar mudanças no DOM
        const observer = new MutationObserver(function () {
            adicionarNovoStatus();
            estilizarStatus();
        });

        // Configurar o observer
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });

        // Executar ao carregar a página
        document.addEventListener('DOMContentLoaded', function () {
            adicionarNovoStatus();
            estilizarStatus();
        });

        // Também executar agora caso o DOM já esteja carregado
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            adicionarNovoStatus();
            estilizarStatus();
        }

        // Executar periodicamente para garantir
        setInterval(function () {
            adicionarNovoStatus();
            estilizarStatus();
        }, 1000);
    })();
</script>

<script>
    // Script para adicionar o status "Disponível para Uso" com estilo azul piscando

    (function () {
        // Adicionar estilos CSS para o novo status
        const estilos = document.createElement('style');
        estilos.textContent = `
            /* Status "Disponível para Uso" em azul e piscando */
            .status-disponivel, span:contains('Disponível para Uso') {
                background-color: rgba(0, 123, 255, 0.1) !important;
                color: #0275d8 !important;
                animation: piscar-azul 1s infinite !important;
                font-weight: bold !important;
            }
            
            /* Animação de piscar azul */
            @keyframes piscar-azul {
                0% { opacity: 1; }
                50% { opacity: 0.6; }
                100% { opacity: 1; }
            }
            
            /* Adicionar a opção ao dropdown de status */
            option[value="Disponível para Uso"] {
                color: #0275d8;
                font-weight: bold;
            }
        `;
        document.head.appendChild(estilos);

        // Função para adicionar o novo status ao dropdown
        function adicionarNovoStatus() {
            // Encontrar todos os selects de status
            document.querySelectorAll('select#collectorStatus').forEach(select => {
                // Verificar se a opção já existe
                let opcaoExiste = false;
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value === 'Disponível para Uso') {
                        opcaoExiste = true;
                        break;
                    }
                }

                // Adicionar a opção se não existir
                if (!opcaoExiste) {
                    const opcao = document.createElement('option');
                    opcao.value = 'Disponível para Uso';
                    opcao.textContent = 'Disponível para Uso';

                    // Inserir após a opção "Ativo"
                    let aposAtivo = false;
                    for (let i = 0; i < select.options.length; i++) {
                        if (select.options[i].value === 'Ativo') {
                            aposAtivo = true;
                        } else if (aposAtivo) {
                            select.insertBefore(opcao, select.options[i]);
                            break;
                        }
                    }

                    // Se não encontrou a posição certa, adiciona ao final
                    if (!aposAtivo || select.options.length <= 1) {
                        select.appendChild(opcao);
                    }
                }
            });
        }

        // Função para estilizar os status
        function estilizarStatus() {
            // Para cada elemento com a classe .status
            document.querySelectorAll('.status').forEach(function (elemento) {
                const texto = elemento.textContent.trim();

                if (texto === 'Disponível para Uso') {
                    elemento.classList.add('status-disponivel');
                    elemento.style.animation = 'piscar-azul 1s infinite';
                    elemento.style.color = '#0275d8';
                    elemento.style.backgroundColor = 'rgba(0, 123, 255, 0.1)';
                    elemento.style.fontWeight = 'bold';
                }
            });
        }

        // Observer para monitorar mudanças no DOM
        const observer = new MutationObserver(function () {
            adicionarNovoStatus();
            estilizarStatus();
        });

        // Configurar o observer
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });

        // Executar ao carregar a página
        document.addEventListener('DOMContentLoaded', function () {
            adicionarNovoStatus();
            estilizarStatus();
        });

        // Também executar agora caso o DOM já esteja carregado
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            adicionarNovoStatus();
            estilizarStatus();
        }

        // Executar periodicamente para garantir
        setInterval(function () {
            adicionarNovoStatus();
            estilizarStatus();
        }, 1000);
    })();
</script>

<script>
    // Script para remover a seção "Coletores em Uso Agora"
    document.addEventListener('DOMContentLoaded', function () {
        // Encontrar a seção pelo seletor de classe
        const secaoColetoresEmUso = document.querySelector('.collectors-in-use');

        if (secaoColetoresEmUso) {
            console.log("Seção 'Coletores em Uso Agora' encontrada, removendo...");

            // Método 1: Ocultar a seção (mantém o elemento no DOM, mas invisível)
            secaoColetoresEmUso.style.display = 'none';

            // Método 2 (alternativo): Remover completamente do DOM
            // Descomente a linha abaixo se preferir remover completamente
            // secaoColetoresEmUso.parentNode.removeChild(secaoColetoresEmUso);

            console.log("Seção 'Coletores em Uso Agora' removida com sucesso");
        } else {
            console.log("Seção 'Coletores em Uso Agora' não encontrada");
        }
    });

</script>

<script>
    // Script para remover botões específicos e adicionar campo de pesquisa
    document.addEventListener('DOMContentLoaded', function () {
        // 1. Remover os botões especificados
        const botoesParaRemover = [
            'btnExportJSON',    // Exportar JSON
            'btnImportJSON',    // Importar JSON
            'btnSaveLocal',     // Salvar no Navegador
            'btnLoadLocal'      // Carregar do Navegador
        ];

        botoesParaRemover.forEach(idBotao => {
            const botao = document.getElementById(idBotao);
            if (botao) {
                console.log(`Removendo botão: ${idBotao}`);
                botao.style.display = 'none';
            }
        });

        // 2. Adicionar campo de pesquisa
        // Encontrar o container onde queremos adicionar a pesquisa
        const sectionTitle = document.querySelector('.section-title');

        if (sectionTitle) {
            console.log("Container para campo de pesquisa encontrado, adicionando campo...");

            // Criar o campo de pesquisa
            const searchContainer = document.createElement('div');
            searchContainer.className = 'search-container';
            searchContainer.style.display = 'flex';
            searchContainer.style.alignItems = 'center';
            searchContainer.style.marginBottom = '15px';
            searchContainer.style.marginTop = '15px';

            // Estrutura do campo de pesquisa
            searchContainer.innerHTML = `
      <div style="position: relative; flex-grow: 1;">
        <input type="text" id="searchCollectors" placeholder="Pesquisar por nome ou ID do coletor" 
               style="width: 100%; padding: 8px 35px 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
        <i class="fas fa-search" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #6c757d;"></i>
      </div>
      <button id="btnClearSearch" class="btn btn-outline" style="margin-left: 10px; display: none;">
        <i class="fas fa-times"></i> Limpar
      </button>
    `;

            // Inserir o campo de pesquisa antes da tabela
            const table = document.querySelector('table');
            if (table && table.parentNode) {
                table.parentNode.insertBefore(searchContainer, table);

                // Adicionar funcionalidade de pesquisa
                const searchInput = document.getElementById('searchCollectors');
                const clearButton = document.getElementById('btnClearSearch');

                if (searchInput && clearButton) {
                    // Função para filtrar os coletores
                    function filtrarColetores() {
                        const termo = searchInput.value.toLowerCase();
                        const linhasTabela = document.querySelectorAll('#collectorsTableBody tr');

                        // Mostrar o botão limpar apenas se houver texto
                        clearButton.style.display = termo ? 'block' : 'none';

                        // Para cada linha na tabela
                        let encontrados = 0;
                        linhasTabela.forEach(linha => {
                            // Pegar células de ID e usuário
                            const celulaID = linha.cells[0] ? linha.cells[0].textContent.toLowerCase() : '';
                            const celulaUsuario = linha.cells[1] ? linha.cells[1].textContent.toLowerCase() : '';

                            // Verificar se alguma célula contém o termo buscado
                            const corresponde = celulaID.includes(termo) || celulaUsuario.includes(termo);

                            // Mostrar ou ocultar linha
                            linha.style.display = corresponde ? '' : 'none';

                            if (corresponde) encontrados++;
                        });

                        // Atualizar mensagem de itens encontrados, se existir
                        const infoElemento = document.querySelector('#currentRangeStart');
                        const totalElemento = document.querySelector('#totalItems');

                        if (infoElemento && totalElemento) {
                            infoElemento.textContent = encontrados > 0 ? 1 : 0;

                            // Atualizar o fim do intervalo (não pode ser maior que o número de itens encontrados)
                            const fimElemento = document.querySelector('#currentRangeEnd');
                            if (fimElemento) {
                                fimElemento.textContent = encontrados;
                            }

                            // Manter o total como está
                        }
                    }

                    // Evento de entrada no campo de pesquisa
                    searchInput.addEventListener('input', filtrarColetores);

                    // Evento para o botão limpar
                    clearButton.addEventListener('click', function () {
                        searchInput.value = '';
                        filtrarColetores();
                        searchInput.focus();
                    });

                    console.log("Campo de pesquisa adicionado com sucesso");
                }
            } else {
                console.log("Tabela não encontrada para adicionar campo de pesquisa");
            }
        } else {
            console.log("Container para campo de pesquisa não encontrado");
        }
    });


</script>

<script>
    // Solução simplificada para focar no campo de nome após clicar em Adicionar Colaborador
    document.addEventListener('DOMContentLoaded', function () {
        // Verificar quando o botão Adicionar Colaborador é clicado
        document.addEventListener('click', function (event) {
            // Verificar se o clique foi no botão Adicionar Colaborador
            if (event.target.id === 'btnAddUser' ||
                (event.target.parentElement && event.target.parentElement.id === 'btnAddUser') ||
                (event.target.textContent && event.target.textContent.includes('Adicionar Colaborador'))) {

                console.log('Botão Adicionar Colaborador clicado');

                // Configurar um intervalo para tentar encontrar e focar o campo
                const intervalId = setInterval(function () {
                    // Tentar vários seletores para encontrar o campo de nome
                    const nameInput = document.querySelector('#userName') ||
                        document.querySelector('input[placeholder*="Nome"]') ||
                        document.querySelector('#userForm input:first-of-type') ||
                        document.querySelector('.modal.active input[type="text"]');

                    if (nameInput) {
                        console.log('Campo nome encontrado, aplicando foco');
                        nameInput.focus();
                        clearInterval(intervalId); // Parar de tentar assim que encontrar
                    }
                }, 100); // Verificar a cada 100ms

                // Parar de tentar após 5 segundos para não continuar indefinidamente
                setTimeout(function () {
                    clearInterval(intervalId);
                }, 5000);
            }
        });
    });

</script>

<script>

    // Script para adicionar campos Turno, Data e Horário ao modal de Adicionar/Editar Coletor
    document.addEventListener('DOMContentLoaded', function () {
        // Função para adicionar os novos campos quando o modal for aberto
        function adicionarNovosCampos() {
            // Verificar se o modal está aberto
            const collectorModal = document.getElementById('collectorModal');
            if (!collectorModal || !collectorModal.classList.contains('active')) {
                return; // Sair se o modal não estiver aberto
            }

            console.log("Modal de coletor aberto, adicionando novos campos...");

            // 1. Adicionar campos de Data e Horário no topo do modal (conforme desenho)
            const modalTitle = document.querySelector('#modalTitle');

            if (modalTitle && !document.getElementById('dataHorarioContainer')) {
                // Criar container para data e horário
                const dataHorarioContainer = document.createElement('div');
                dataHorarioContainer.id = 'dataHorarioContainer';
                dataHorarioContainer.style.display = 'flex';
                dataHorarioContainer.style.justifyContent = 'flex-end';
                dataHorarioContainer.style.marginBottom = '10px';
                dataHorarioContainer.style.marginTop = '-15px';

                // Adicionar campos de data e horário
                dataHorarioContainer.innerHTML = `
        <div style="display: flex; align-items: center; margin-right: 15px;">
          <span style="font-weight: 500; margin-right: 10px;">Data:</span>
          <span id="collectorDataTop" style="background-color: #f8f9fa; padding: 5px 10px; border-radius: 4px;">${formatarData()}</span>
        </div>
        <div style="display: flex; align-items: center;">
          <span style="font-weight: 500; margin-right: 10px;">Hora:</span>
          <span id="collectorHorarioTop" style="background-color: #f8f9fa; padding: 5px 10px; border-radius: 4px;">${formatarHora()}</span>
        </div>
      `;

                // Inserir após o título do modal
                modalTitle.parentNode.insertBefore(dataHorarioContainer, modalTitle.nextSibling);
            }

            // 2. Adicionar campo de Turno
            const sectorFormCol = document.querySelector('#collectorSector').closest('.form-col');
            const statusFormCol = document.querySelector('#collectorStatus').closest('.form-col');

            if (sectorFormCol && statusFormCol) {
                // Criar um novo form-row após o row do setor/status
                const formRow = sectorFormCol.closest('.form-row');
                const novoFormRow = document.createElement('div');
                novoFormRow.className = 'form-row';
                novoFormRow.id = 'turnoRow';

                // Verificar se o campo já foi adicionado para evitar duplicação
                if (!document.getElementById('collectorTurno')) {
                    novoFormRow.innerHTML = `
          <div class="form-col">
            <div class="form-group">
              <label class="form-label" for="collectorTurno">Turno</label>
              <select class="form-control" id="collectorTurno" required>
                <option value="1º Turno">1º Turno</option>
                <option value="Intermediário">Intermediário</option>
                <option value="2º Turno">2º Turno</option>
              </select>
            </div>
          </div>
          <div class="form-col">
            <div class="form-group">
              <label class="form-label" for="collectorDataHidden">Data Vigente</label>
              <input type="hidden" id="collectorDataHidden" value="${formatarData()}" readonly>
              <div style="padding: 0.75rem 1rem; border: 1px solid #ddd; border-radius: 5px; background-color: #f8f9fa; color: #6c757d;">
                ${formatarData()}
              </div>
            </div>
          </div>
        `;

                    // Inserir o novo form-row após o row do setor/status
                    formRow.parentNode.insertBefore(novoFormRow, formRow.nextSibling);
                }
            }

            // Não precisamos mais do campo de horário na posição anterior
            // pois agora ele está no topo do modal junto com a data

            console.log("Novos campos adicionados com sucesso!");
        }

        // Função para formatar a data atual (DD/MM/YYYY)
        function formatarData() {
            const hoje = new Date();
            const dia = String(hoje.getDate()).padStart(2, '0');
            const mes = String(hoje.getMonth() + 1).padStart(2, '0');
            const ano = hoje.getFullYear();
            return `${dia}/${mes}/${ano}`;
        }

        // Função para formatar a hora atual (HH:MM)
        function formatarHora() {
            const agora = new Date();
            const horas = String(agora.getHours()).padStart(2, '0');
            const minutos = String(agora.getMinutes()).padStart(2, '0');
            return `${horas}:${minutos}`;
        }

        // Função para salvar os valores de data e hora quando o formulário for enviado
        function configurarSalvamentoDadosTemporais() {
            const saveButton = document.getElementById('saveCollector');
            if (saveButton) {
                // Preservar o evento de clique original
                const originalClickHandler = saveButton.onclick;

                saveButton.onclick = function (event) {
                    // Transferir valores dos campos de exibição para campos ocultos
                    const dataTop = document.getElementById('collectorDataTop');
                    const horaTop = document.getElementById('collectorHorarioTop');
                    const dataHidden = document.getElementById('collectorDataHidden');

                    if (dataTop && dataHidden) {
                        dataHidden.value = dataTop.textContent;
                    }

                    // Criar campo oculto para o horário se não existir
                    if (horaTop && !document.getElementById('collectorHorarioHidden')) {
                        const horaHidden = document.createElement('input');
                        horaHidden.type = 'hidden';
                        horaHidden.id = 'collectorHorarioHidden';
                        horaHidden.name = 'collectorHorario';
                        horaHidden.value = horaTop.textContent;
                        document.getElementById('collectorForm').appendChild(horaHidden);
                    }

                    // Chamar o handler original
                    if (typeof originalClickHandler === 'function') {
                        originalClickHandler.call(this, event);
                    }
                };
            }
        }

        // Observar a abertura do modal de coletores
        const observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
                if (mutation.type === 'attributes' &&
                    mutation.attributeName === 'class' &&
                    mutation.target.id === 'collectorModal' &&
                    mutation.target.classList.contains('active')) {

                    // Modal foi aberto, adicionar os campos
                    setTimeout(function () {
                        adicionarNovosCampos();
                        configurarSalvamentoDadosTemporais();
                    }, 100);
                }
            });
        });

        // Configurar o observer para monitorar mudanças no modal
        const collectorModal = document.getElementById('collectorModal');
        if (collectorModal) {
            observer.observe(collectorModal, {
                attributes: true,
                attributeFilter: ['class']
            });
            console.log("Observer configurado para o modal de coletores");
        }

        // Adicionar evento ao botão de adicionar coletor
        const btnAddCollector = document.getElementById('btnAddCollector');
        if (btnAddCollector) {
            btnAddCollector.addEventListener('click', function () {
                setTimeout(function () {
                    adicionarNovosCampos();
                    configurarSalvamentoDadosTemporais();
                }, 300);
            });
        }

        // Adicionar evento aos botões de editar coletor
        document.addEventListener('click', function (event) {
            const isEditButton = event.target.closest('.btn-edit');
            if (isEditButton) {
                setTimeout(function () {
                    adicionarNovosCampos();
                    configurarSalvamentoDadosTemporais();
                }, 300);
            }
        });

        // Verificar se o modal já está aberto ao carregar a página
        if (collectorModal && collectorModal.classList.contains('active')) {
            setTimeout(function () {
                adicionarNovosCampos();
                configurarSalvamentoDadosTemporais();
            }, 300);
        }
    });

</script>

<script>
    // No início do arquivo, após as declarações iniciais ou importações:
    document.addEventListener('DOMContentLoaded', function () {
        // Configurações globais
        const CONFIG = {
            // Status disponíveis para os coletores
            STATUS: {
                DISPONIVEL: 'Disponível para Uso',
                EM_USO: 'Em Uso',
                MANUTENCAO: 'Em Manutenção',
                PROBLEMA: 'Com Problema'
            },
            // Permissões de usuário
            ROLES: {
                ADMIN: 'admin',
                COLABORADOR: 'colaborador'
            }
        };

        // Inicializar bancos de dados locais se não existirem
        function inicializarBancoDeDados() {
            // Código da função inicializarBancoDeDados...
        }

        // Função para gerar ID único
        function generateUniqueId() {
            // Código da função generateUniqueId...
        }

        // Função para adicionar botão Devolver
        function adicionarBotaoDevolver() {
            // Código da função adicionarBotaoDevolver...
        }

        // Função para calcular o tempo de uso
        function calcularTempoUso(startTime) {
            // Código da função calcularTempoUso...
        }

        // Função para processar a devolução do coletor
        function devolverColetor(id, linha) {
            // Código da função devolverColetor...
        }

        // Função para registrar no histórico
        function registrarHistoricoDevolucao(dados) {
            // Código da função registrarHistoricoDevolucao...
        }

        // Função para atualizar painéis de estatísticas
        function atualizarPaineisEstatisticas() {
            // Código da função atualizarPaineisEstatisticas...
        }

        // Função para atualizar a lista de coletores em uso
        function atualizarListaColetoresEmUso() {
            // Código da função atualizarListaColetoresEmUso...
        }

        // Função para formatar a data atual (DD/MM/YYYY)
        function formatarData() {
            // Código da função formatarData...
        }

        // Função para formatar a hora atual (HH:MM)
        function formatarHora() {
            // Código da função formatarHora...
        }

        // Função para adicionar botão de histórico
        function adicionarBotaoHistorico() {
            // Código da função adicionarBotaoHistorico...
        }

        // Função para abrir modal de histórico
        function abrirModalHistorico() {
            // Código da função abrirModalHistorico...
        }

        // Função para carregar histórico na tabela
        function carregarHistorico() {
            // Código da função carregarHistorico...
        }

        // Função para filtrar histórico
        function filtrarHistorico() {
            // Código da função filtrarHistorico...
        }

        // Função para exportar histórico como CSV
        function exportarHistoricoCsv() {
            // Código da função exportarHistoricoCsv...
        }

        // Função para converter data string para objeto Date
        function converterDataParaObj(dataStr) {
            // Código da função converterDataParaObj...
        }

        // Inicializar
        inicializarBancoDeDados();
        adicionarBotaoDevolver();
        adicionarBotaoHistorico();

        // Atualizar a interface periodicamente
        setInterval(function () {
            adicionarBotaoDevolver();
            atualizarListaColetoresEmUso();
        }, 10000); // A cada 10 segundos
    });

</script>

<script>
    //No início do arquivo, após as declarações iniciais ou importações:
    document.addEventListener('DOMContentLoaded', function () {
        // Configurações globais
        const CONFIG = {
            // Status disponíveis para os coletores
            STATUS: {
                DISPONIVEL: 'Disponível para Uso',
                EM_USO: 'Em Uso',
                MANUTENCAO: 'Em Manutenção',
                PROBLEMA: 'Com Problema'
            },
            // Permissões de usuário
            ROLES: {
                ADMIN: 'admin',
                COLABORADOR: 'colaborador'
            }
        };

        // Inicializar bancos de dados locais se não existirem
        function inicializarBancoDeDados() {
            // Código da função inicializarBancoDeDados...
        }

        // Função para gerar ID único
        function generateUniqueId() {
            // Código da função generateUniqueId...
        }

        // Função para adicionar botão Devolver
        function adicionarBotaoDevolver() {
            // Código da função adicionarBotaoDevolver...
        }

        // Função para calcular o tempo de uso
        function calcularTempoUso(startTime) {
            // Código da função calcularTempoUso...
        }

        // Função para processar a devolução do coletor
        function devolverColetor(id, linha) {
            // Código da função devolverColetor...
        }

        // Função para registrar no histórico
        function registrarHistoricoDevolucao(dados) {
            // Código da função registrarHistoricoDevolucao...
        }

        // Função para atualizar painéis de estatísticas
        function atualizarPaineisEstatisticas() {
            // Código da função atualizarPaineisEstatisticas...
        }

        // Função para atualizar a lista de coletores em uso
        function atualizarListaColetoresEmUso() {
            // Código da função atualizarListaColetoresEmUso...
        }

        // Função para formatar a data atual (DD/MM/YYYY)
        function formatarData() {
            // Código da função formatarData...
        }

        // Função para formatar a hora atual (HH:MM)
        function formatarHora() {
            // Código da função formatarHora...
        }

        // Função para adicionar botão de histórico
        function adicionarBotaoHistorico() {
            // Código da função adicionarBotaoHistorico...
        }

        // Função para abrir modal de histórico
        function abrirModalHistorico() {
            // Código da função abrirModalHistorico...
        }

        // Função para carregar histórico na tabela
        function carregarHistorico() {
            // Código da função carregarHistorico...
        }

        // Função para filtrar histórico
        function filtrarHistorico() {
            // Código da função filtrarHistorico...
        }

        // Função para exportar histórico como CSV
        function exportarHistoricoCsv() {
            // Código da função exportarHistoricoCsv...
        }

        // Função para converter data string para objeto Date
        function converterDataParaObj(dataStr) {
            // Código da função converterDataParaObj...
        }

        // Inicializar
        inicializarBancoDeDados();
        adicionarBotaoDevolver();
        adicionarBotaoHistorico();

        // Atualizar a interface periodicamente
        setInterval(function () {
            adicionarBotaoDevolver();
            atualizarListaColetoresEmUso();
        }, 10000); // A cada 10 segundos
    });

</script>

<script>

    // Script aprimorado para registrar informações no banco de dados ao devolver o coletor
    document.addEventListener('DOMContentLoaded', function () {
        // Função para adicionar botão Devolver em cada linha da tabela
        function adicionarBotaoDevolver() {
            console.log("Adicionando botões 'Devolver' aos coletores...");

            // Encontrar todas as linhas da tabela de coletores
            const linhasTabela = document.querySelectorAll('#collectorsTableBody tr');

            linhasTabela.forEach(linha => {
                // Verificar se a ação já foi adicionada
                const celulasAcoes = linha.querySelector('td:last-child');
                if (celulasAcoes && !celulasAcoes.querySelector('.btn-return')) {
                    // Obter o ID do coletor
                    const idColetor = linha.querySelector('td:first-child').textContent.replace('#', '').trim();

                    // Verificar o status atual
                    const statusCell = linha.querySelector('td:nth-child(4)');
                    const statusText = statusCell ? statusCell.textContent.trim() : '';

                    // Só adicionar botão se o status não for "Disponível para Uso"
                    if (statusText !== 'Disponível para Uso') {
                        // Obter o usuário atual (se houver)
                        const usuarioCell = linha.querySelector('td:nth-child(2)');
                        const usuarioAtual = usuarioCell ? usuarioCell.textContent.trim() : '';

                        // Não adicionar botão se não houver usuário
                        if (usuarioAtual === '-' || usuarioAtual === '') return;

                        // Criar botão Devolver
                        const botaoDevolver = document.createElement('button');
                        botaoDevolver.className = 'btn-icon btn-return';
                        botaoDevolver.setAttribute('data-id', idColetor);
                        botaoDevolver.setAttribute('title', 'Devolver coletor');
                        botaoDevolver.innerHTML = '<i class="fas fa-undo"></i>'; // Ícone de "desfazer"
                        botaoDevolver.style.backgroundColor = '#ffc107'; // Cor amarela
                        botaoDevolver.style.marginLeft = '5px';

                        // Adicionar marca de tempo inicial se não existir
                        if (!linha.hasAttribute('data-start-time')) {
                            linha.setAttribute('data-start-time', Date.now());
                        }

                        // Adicionar evento ao botão
                        botaoDevolver.addEventListener('click', function () {
                            devolverColetor(idColetor, linha);
                        });

                        // Adicionar botão ao container de ações
                        const containerAcoes = celulasAcoes.querySelector('.actions');
                        if (containerAcoes) {
                            containerAcoes.appendChild(botaoDevolver);
                        }
                    }
                }
            });
        }

        // Função para calcular o tempo de uso
        function calcularTempoUso(startTime) {
            const agora = Date.now();
            const tempoDecorrido = agora - startTime;

            // Calcular horas, minutos e segundos
            const segundos = Math.floor(tempoDecorrido / 1000);
            const horas = Math.floor(segundos / 3600);
            const minutos = Math.floor((segundos % 3600) / 60);

            // Formatar o tempo (HH:MM)
            return `${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}`;
        }

        // Função para processar a devolução do coletor
        function devolverColetor(id, linha) {
            console.log(`Devolvendo coletor #${id}`);

            // Obter o tempo inicial
            const startTime = linha.getAttribute('data-start-time') || Date.now() - 3600000; // Padrão: 1 hora atrás

            // Calcular o tempo de uso
            const tempoUso = calcularTempoUso(Number(startTime));

            // Obter informações do coletor
            const usuarioCell = linha.querySelector('td:nth-child(2)');
            const setorCell = linha.querySelector('td:nth-child(3)');
            const statusCell = linha.querySelector('td:nth-child(4)');
            const bateriaCell = linha.querySelector('td:nth-child(6)');

            const usuarioAtual = usuarioCell ? usuarioCell.textContent.trim() : '-';
            const setorAtual = setorCell ? setorCell.textContent.trim() : '-';
            const statusAtual = statusCell ? statusCell.textContent.trim() : '';
            const bateriaAtual = bateriaCell ? bateriaCell.textContent.trim() : '100%';

            // Obter data e hora atual
            const dataAtual = formatarData();
            const horaAtual = formatarHora();

            // Confirmar a devolução e mostrar o tempo de uso
            if (confirm(`Tem certeza que deseja devolver o coletor #${id}?\n\nUsuário: ${usuarioAtual}\nTempo de uso: ${tempoUso}`)) {
                // Obter referência à célula de tempo de uso
                const tempoUsoCell = linha.querySelector('td:nth-child(5)');

                // Atualizar as células
                if (usuarioCell) usuarioCell.textContent = '-';
                if (setorCell) setorCell.textContent = '-';

                // Atualizar o status
                if (statusCell) {
                    // Remover classes de status anteriores
                    const statusSpan = statusCell.querySelector('span');
                    if (statusSpan) {
                        statusSpan.classList.remove('status-active', 'status-inactive', 'status-warning', 'status-error');
                        statusSpan.classList.add('status-disponivel');
                        statusSpan.textContent = 'Disponível para Uso';
                    }
                }

                // Atualizar o tempo de uso com o valor calculado
                if (tempoUsoCell) tempoUsoCell.textContent = tempoUso;

                // Remover o botão de devolução, pois não é mais necessário
                const botaoDevolver = linha.querySelector('.btn-return');
                if (botaoDevolver) {
                    botaoDevolver.remove();
                }

                // Remover o atributo de tempo inicial
                linha.removeAttribute('data-start-time');

                // Atualizar o objeto de coletor no array de coletores (se existir)
                if (window.collectors && Array.isArray(window.collectors)) {
                    const coletor = window.collectors.find(c => c.id === id);
                    if (coletor) {
                        // Salvar informações do uso antes de resetar
                        const registroUso = {
                            id_coletor: id,
                            usuario: coletor.usuario || usuarioAtual,
                            setor: coletor.setor || setorAtual,
                            status_anterior: coletor.status || statusAtual,
                            bateria: coletor.bateria || bateriaAtual.replace('%', ''),
                            tempo_uso: tempoUso,
                            data_inicio: coletor.data_inicio || dataAtual,
                            hora_inicio: coletor.hora_inicio || "00:00",
                            data_devolucao: dataAtual,
                            hora_devolucao: horaAtual,
                            observacoes: "Devolvido via botão Devolver"
                        };

                        // Atualizar dados do coletor
                        coletor.usuario = '-';
                        coletor.setor = '-';
                        coletor.status = 'Disponível para Uso';
                        coletor.tempo_uso = '00:00';
                        coletor.data_inicio = '';
                        coletor.hora_inicio = '';

                        // Salvar registro no banco de dados
                        salvarRegistroNoBancoDeDados(registroUso);
                    }
                } else {
                    // Se não existir array de coletores, criar registro manualmente
                    const registroUso = {
                        id_coletor: id,
                        usuario: usuarioAtual,
                        setor: setorAtual,
                        status_anterior: statusAtual,
                        bateria: bateriaAtual.replace('%', ''),
                        tempo_uso: tempoUso,
                        data_inicio: "Desconhecida",
                        hora_inicio: "Desconhecida",
                        data_devolucao: dataAtual,
                        hora_devolucao: horaAtual,
                        observacoes: "Devolvido via botão Devolver"
                    };

                    // Salvar registro no banco de dados
                    salvarRegistroNoBancoDeDados(registroUso);
                }

                // Mostrar mensagem de sucesso
                alert(`Coletor #${id} devolvido com sucesso!\nTempo de uso: ${tempoUso}\nInformações registradas no banco de dados.`);
            }
        }

        // Função para salvar o registro no banco de dados
        function salvarRegistroNoBancoDeDados(registro) {
            console.log("Salvando registro no banco de dados:", registro);

            try {
                // 1. Tentar salvar usando API existente (se houver)
                if (typeof saveCollectorUsageRecord === 'function') {
                    saveCollectorUsageRecord(registro);
                    console.log("Registro salvo via API existente");
                    return;
                }

                // 2. Tentar salvar usando localStorage como fallback
                if (window.localStorage) {
                    // Obter registros existentes
                    let registrosUso = JSON.parse(localStorage.getItem('collectorUsageRecords') || '[]');

                    // Adicionar novo registro
                    registrosUso.push({
                        ...registro,
                        timestamp: Date.now()
                    });

                    // Salvar de volta no localStorage
                    localStorage.setItem('collectorUsageRecords', JSON.stringify(registrosUso));
                    console.log("Registro salvo no localStorage (fallback)");

                    // Se existir uma função para sincronizar com o banco de dados
                    if (typeof syncLocalStorageWithDatabase === 'function') {
                        syncLocalStorageWithDatabase();
                    }
                }

                // 3. Usar AJAX para enviar para o servidor
                if (window.fetch) {
                    // Exemplo de chamada AJAX para o endpoint do servidor
                    fetch('/api/collector-usage', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(registro)
                    })
                        .then(response => {
                            if (response.ok) {
                                console.log("Registro enviado para o servidor via AJAX");
                            } else {
                                console.error("Erro ao enviar registro para o servidor:", response.statusText);
                            }
                        })
                        .catch(error => {
                            console.error("Erro de rede ao enviar registro:", error);
                        });
                }

                // 4. Manter um array global como último recurso
                if (!window.collectorUsageRecords) {
                    window.collectorUsageRecords = [];
                }
                window.collectorUsageRecords.push({
                    ...registro,
                    timestamp: Date.now()
                });
                console.log("Registro adicionado ao array global (último recurso)");

            } catch (error) {
                console.error("Erro ao salvar registro no banco de dados:", error);
            }
        }

        // Função para formatar a data atual (DD/MM/YYYY)
        function formatarData() {
            const hoje = new Date();
            const dia = String(hoje.getDate()).padStart(2, '0');
            const mes = String(hoje.getMonth() + 1).padStart(2, '0');
            const ano = hoje.getFullYear();
            return `${dia}/${mes}/${ano}`;
        }

        // Função para formatar a hora atual (HH:MM)
        function formatarHora() {
            const agora = new Date();
            const horas = String(agora.getHours()).padStart(2, '0');
            const minutos = String(agora.getMinutes()).padStart(2, '0');
            return `${horas}:${minutos}`;
        }

        // Adicionar marca de tempo inicial para coletores já em uso
        function inicializarTempoUso() {
            const linhasTabela = document.querySelectorAll('#collectorsTableBody tr');

            linhasTabela.forEach(linha => {
                // Verificar se já tem data-start-time
                if (!linha.hasAttribute('data-start-time')) {
                    // Verificar se tem usuário (não está disponível)
                    const usuarioCell = linha.querySelector('td:nth-child(2)');
                    const statusCell = linha.querySelector('td:nth-child(4)');

                    const usuarioAtual = usuarioCell ? usuarioCell.textContent.trim() : '-';
                    const statusAtual = statusCell ? statusCell.textContent.trim() : '';

                    if (usuarioAtual !== '-' && usuarioAtual !== '' && statusAtual !== 'Disponível para Uso') {
                        // Calcular tempo inicial aproximado baseado no tempo de uso atual
                        const tempoUsoCell = linha.querySelector('td:nth-child(5)');
                        const tempoUsoAtual = tempoUsoCell ? tempoUsoCell.textContent.trim() : '00:00';

                        // Converter o tempo de uso para milissegundos
                        const [horas, minutos] = tempoUsoAtual.split(':').map(Number);
                        const tempoEmMs = (horas * 3600 + minutos * 60) * 1000;

                        // Definir hora inicial (hora atual menos o tempo de uso)
                        const tempoInicial = Date.now() - tempoEmMs;
                        linha.setAttribute('data-start-time', tempoInicial);

                        // Registrar data e hora iniciais no objeto coletor (se existir)
                        if (window.collectors && Array.isArray(window.collectors)) {
                            const idColetor = linha.querySelector('td:first-child').textContent.replace('#', '').trim();
                            const coletor = window.collectors.find(c => c.id === idColetor);

                            if (coletor && !coletor.data_inicio) {
                                const dataInicio = new Date(tempoInicial);
                                coletor.data_inicio = formatarDataDeTimestamp(dataInicio);
                                coletor.hora_inicio = formatarHoraDeTimestamp(dataInicio);
                            }
                        }
                    }
                }
            });
        }

        // Função para formatar data a partir de timestamp
        function formatarDataDeTimestamp(data) {
            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear();
            return `${dia}/${mes}/${ano}`;
        }

        // Função para formatar hora a partir de timestamp
        function formatarHoraDeTimestamp(data) {
            const horas = String(data.getHours()).padStart(2, '0');
            const minutos = String(data.getMinutes()).padStart(2, '0');
            return `${horas}:${minutos}`;
        }

        // Adicionar os botões quando a página carregar
        setTimeout(function () {
            inicializarTempoUso();
            adicionarBotaoDevolver();
        }, 500);

        // Adicionar os botões sempre que a tabela for atualizada (por exemplo, ao mudar de página)
        const observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
                if (mutation.type === 'childList' &&
                    mutation.target.id === 'collectorsTableBody') {
                    setTimeout(function () {
                        inicializarTempoUso();
                        adicionarBotaoDevolver();
                    }, 100);
                }
            });
        });

        // Observar mudanças na tabela
        const tableBody = document.getElementById('collectorsTableBody');
        if (tableBody) {
            observer.observe(tableBody, {
                childList: true,
                subtree: true
            });
        }

        // Verificar se há botões de navegação de página e adicionar eventos
        const btnPrev = document.getElementById('prevPageBtn');
        const btnNext = document.getElementById('nextPageBtn');

        if (btnPrev) {
            btnPrev.addEventListener('click', function () {
                setTimeout(function () {
                    inicializarTempoUso();
                    adicionarBotaoDevolver();
                }, 100);
            });
        }

        if (btnNext) {
            btnNext.addEventListener('click', function () {
                setTimeout(function () {
                    inicializarTempoUso();
                    adicionarBotaoDevolver();
                }, 100);
            });
        }

        // Verificar periodicamente se há novos coletores na tabela
        setInterval(function () {
            inicializarTempoUso();
            adicionarBotaoDevolver();
        }, 5000);
    });

</script>

<script>

    // Script para salvar todos os campos no banco de dados, incluindo Turno, Data e Hora
    document.addEventListener('DOMContentLoaded', function () {
        // Monitorar submissão do formulário de adicionar/editar coletor
        function monitorarSubmissaoFormulario() {
            console.log("Configurando monitoramento de submissão do formulário...");

            // Encontrar o botão de salvar
            const saveButton = document.getElementById('saveCollector') || document.querySelector('.modal button.save');

            if (saveButton) {
                // Preservar o evento original de clique
                const originalClickHandler = saveButton.onclick;

                // Substituir com nossa própria função
                saveButton.onclick = function (event) {
                    // Capturar todos os dados do formulário, incluindo os novos campos
                    const dadosCompletos = capturarDadosFormulario();

                    // Salvar os dados no banco de dados
                    salvarDadosNoBancoDeDados(dadosCompletos);

                    // Chamar o handler original para preservar a funcionalidade existente
                    if (typeof originalClickHandler === 'function') {
                        return originalClickHandler.call(this, event);
                    }
                };

                console.log("Monitoramento de submissão configurado com sucesso");
            } else {
                console.log("Botão de salvar não encontrado");
            }
        }

        // Função para capturar todos os dados do formulário
        function capturarDadosFormulario() {
            console.log("Capturando dados do formulário...");

            // Dados básicos do coletor
            const idColetor = document.getElementById('collectorId') ? document.getElementById('collectorId').value : '';
            const modelo = document.getElementById('collectorModel') ? document.getElementById('collectorModel').value : '';
            const numeroSerie = document.getElementById('collectorSerialNumber') ? document.getElementById('collectorSerialNumber').value : '';
            const usuario = document.getElementById('collectorUser') ? document.getElementById('collectorUser').value : '';
            const setor = document.getElementById('collectorSector') ? document.getElementById('collectorSector').value : '';
            const status = document.getElementById('collectorStatus') ? document.getElementById('collectorStatus').value : '';
            const bateria = document.getElementById('collectorBattery') ? document.getElementById('collectorBattery').value : '';
            const tempoUso = document.getElementById('collectorUsageTime') ? document.getElementById('collectorUsageTime').value : '';

            // Novos campos
            const turno = document.getElementById('collectorTurno') ? document.getElementById('collectorTurno').value : '';

            // Campos de data e hora no formato exibido no topo do modal
            let dataVigente = document.getElementById('collectorDataTop') ?
                document.getElementById('collectorDataTop').textContent : formatarData();

            let horaAtual = document.getElementById('collectorHorarioTop') ?
                document.getElementById('collectorHorarioTop').textContent : formatarHora();

            // Verificar se existe o campo Data Vigente no formulário
            if (document.getElementById('collectorDataHidden')) {
                dataVigente = document.getElementById('collectorDataHidden').value;
            }

            // Dados completos
            const dadosCompletos = {
                id: idColetor,
                modelo: modelo,
                numero_serie: numeroSerie,
                usuario: usuario,
                setor: setor,
                status: status,
                bateria: bateria,
                tempo_uso: tempoUso,
                turno: turno,
                data_vigente: dataVigente,
                hora_registro: horaAtual,
                data_atualizacao: formatarData(),
                hora_atualizacao: formatarHora(),
                eh_edicao: !!document.getElementById('editingCollector')
            };

            console.log("Dados capturados:", dadosCompletos);
            return dadosCompletos;
        }

        // Função para salvar dados no banco de dados
        function salvarDadosNoBancoDeDados(dados) {
            console.log("Salvando dados no banco de dados:", dados);

            try {
                // 1. Tentar salvar usando a API existente (se houver)
                if (typeof saveCollectorData === 'function') {
                    saveCollectorData(dados);
                    console.log("Dados salvos via API existente");
                    return;
                }

                // 2. Atualizar o objeto no array de coletores (se existir)
                if (window.collectors && Array.isArray(window.collectors)) {
                    // Procurar o coletor pelo ID
                    const index = window.collectors.findIndex(c => c.id === dados.id);

                    if (index !== -1) {
                        // Atualizar coletor existente
                        window.collectors[index] = {
                            ...window.collectors[index],
                            ...dados
                        };
                        console.log("Dados atualizados no array de coletores");
                    } else {
                        // Adicionar novo coletor
                        window.collectors.push(dados);
                        console.log("Novo coletor adicionado ao array de coletores");
                    }
                }

                // 3. Tentar salvar usando localStorage como fallback
                if (window.localStorage) {
                    // Obter coletores existentes
                    let coletores = JSON.parse(localStorage.getItem('collectors') || '[]');

                    // Procurar o coletor pelo ID
                    const index = coletores.findIndex(c => c.id === dados.id);

                    if (index !== -1) {
                        // Atualizar coletor existente
                        coletores[index] = {
                            ...coletores[index],
                            ...dados
                        };
                    } else {
                        // Adicionar novo coletor
                        coletores.push(dados);
                    }

                    // Salvar de volta no localStorage
                    localStorage.setItem('collectors', JSON.stringify(coletores));
                    console.log("Dados salvos no localStorage (fallback)");
                }

                // 4. Usar AJAX para enviar para o servidor
                if (window.fetch) {
                    fetch('/api/collectors', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(dados)
                    })
                        .then(response => {
                            if (response.ok) {
                                console.log("Dados enviados para o servidor via AJAX");
                            } else {
                                console.error("Erro ao enviar dados para o servidor:", response.statusText);
                            }
                        })
                        .catch(error => {
                            console.error("Erro de rede ao enviar dados:", error);
                        });
                }

            } catch (error) {
                console.error("Erro ao salvar dados no banco de dados:", error);
            }
        }

        // Função para formatar a data atual (DD/MM/YYYY)
        function formatarData() {
            const hoje = new Date();
            const dia = String(hoje.getDate()).padStart(2, '0');
            const mes = String(hoje.getMonth() + 1).padStart(2, '0');
            const ano = hoje.getFullYear();
            return `${dia}/${mes}/${ano}`;
        }

        // Função para formatar a hora atual (HH:MM)
        function formatarHora() {
            const agora = new Date();
            const horas = String(agora.getHours()).padStart(2, '0');
            const minutos = String(agora.getMinutes()).padStart(2, '0');
            return `${horas}:${minutos}`;
        }

        // Função para adicionar botão Devolver
        function adicionarBotaoDevolver() {
            // Implementação existente do botão Devolver (código anterior)
            // ...
        }

        // Observar a abertura do modal de coletores para configurar monitoramento
        const observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
                if (mutation.type === 'attributes' &&
                    mutation.attributeName === 'class' &&
                    mutation.target.id === 'collectorModal' &&
                    mutation.target.classList.contains('active')) {

                    // Modal foi aberto, configurar monitoramento do formulário
                    setTimeout(monitorarSubmissaoFormulario, 300);
                }
            });
        });

        // Configurar o observer para monitorar mudanças no modal
        const collectorModal = document.getElementById('collectorModal');
        if (collectorModal) {
            observer.observe(collectorModal, {
                attributes: true,
                attributeFilter: ['class']
            });
            console.log("Observer configurado para o modal de coletores");
        }

        // Adicionar evento ao botão de adicionar coletor
        const btnAddCollector = document.getElementById('btnAddCollector');
        if (btnAddCollector) {
            btnAddCollector.addEventListener('click', function () {
                setTimeout(monitorarSubmissaoFormulario, 500);
            });
        }

        // Adicionar evento aos botões de editar coletor
        document.addEventListener('click', function (event) {
            const isEditButton = event.target.closest('.btn-edit');
            if (isEditButton) {
                setTimeout(monitorarSubmissaoFormulario, 500);
            }
        });

        // Verificar se o modal já está aberto ao carregar a página
        if (collectorModal && collectorModal.classList.contains('active')) {
            setTimeout(monitorarSubmissaoFormulario, 500);
        }

        // Inicializar
        setTimeout(function () {
            adicionarBotaoDevolver();
        }, 500);
    });
</script>

<script>
    // Script para sincronizar operações de coletores com o banco de dados
    document.addEventListener('DOMContentLoaded', function () {
        // ===== Configurações =====
        const CONFIG = {
            STORAGE_KEY: 'sistema_coletores_cache',
            CACHE_DURATION: 30 * 60 * 1000, // 30 minutos em ms
            API_ENDPOINTS: {
                COLETORES: '/api/coletores',
                USUARIOS: '/api/usuarios'
            }
        };

        // ===== Gerenciamento de Cache =====
        const CacheManager = {
            // Salvar dados no cache local
            saveToCache: function (key, data) {
                const cacheData = {
                    timestamp: Date.now(),
                    data: data
                };
                localStorage.setItem(`${CONFIG.STORAGE_KEY}_${key}`, JSON.stringify(cacheData));
            },

            // Recuperar dados do cache
            getFromCache: function (key) {
                const cachedData = localStorage.getItem(`${CONFIG.STORAGE_KEY}_${key}`);
                if (!cachedData) return null;

                const parsedData = JSON.parse(cachedData);
                const now = Date.now();

                // Verificar se o cache expirou
                if (now - parsedData.timestamp > CONFIG.CACHE_DURATION) {
                    localStorage.removeItem(`${CONFIG.STORAGE_KEY}_${key}`);
                    return null;
                }

                return parsedData.data;
            },

            // Limpar o cache de uma chave específica
            clearCache: function (key) {
                localStorage.removeItem(`${CONFIG.STORAGE_KEY}_${key}`);
            },

            // Limpar todo o cache do sistema
            clearAllCache: function () {
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith(CONFIG.STORAGE_KEY)) {
                        keysToRemove.push(key);
                    }
                }
                keysToRemove.forEach(key => localStorage.removeItem(key));
            }
        };

        // ===== API Service =====
        const ApiService = {
            // Carregar coletores do banco de dados ou do cache
            loadColetores: function (forceRefresh = false) {
                return new Promise((resolve, reject) => {
                    // Verificar se podemos usar o cache
                    if (!forceRefresh) {
                        const cachedData = CacheManager.getFromCache('coletores');
                        if (cachedData) {
                            console.log('Carregando coletores do cache');
                            if (typeof updateUI === 'function') {
                                updateUI(cachedData);
                            }
                            return resolve(cachedData);
                        }
                    }

                    // Buscar do servidor
                    console.log('Carregando coletores do servidor');
                    fetch(CONFIG.API_ENDPOINTS.COLETORES)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`Erro ao carregar coletores: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            // Salvar no cache
                            CacheManager.saveToCache('coletores', data);

                            // Atualizar a UI
                            if (typeof updateUI === 'function') {
                                updateUI(data);
                            }

                            resolve(data);
                        })
                        .catch(error => {
                            console.error('Erro ao carregar coletores:', error);
                            reject(error);
                        });
                });
            },

            // Excluir um coletor do banco de dados
            excluirColetor: function (idColetor) {
                return new Promise((resolve, reject) => {
                    // Confirmar a exclusão
                    if (!confirm(`Tem certeza que deseja remover o coletor #${idColetor}?`)) {
                        return reject(new Error('Operação cancelada pelo usuário'));
                    }

                    console.log(`Excluindo coletor #${idColetor} do banco de dados`);

                    // Realizar a requisição para a API
                    fetch(`${CONFIG.API_ENDPOINTS.COLETORES}/${idColetor}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                        .then(response => {
                            if (!response.ok) {
                                return response.json().then(data => {
                                    throw new Error(data.erro || `Erro ao excluir coletor: ${response.status}`);
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('Resposta do servidor:', data);

                            // Remover do cache local
                            const cachedColetores = CacheManager.getFromCache('coletores');
                            if (cachedColetores) {
                                const updatedCache = cachedColetores.filter(c => c.id !== idColetor);
                                CacheManager.saveToCache('coletores', updatedCache);
                            }

                            // Atualizar a UI sem recarregar do servidor
                            if (window.collectors && Array.isArray(window.collectors)) {
                                window.collectors = window.collectors.filter(c => c.id !== idColetor);
                                if (typeof renderCollectorsTable === 'function') {
                                    renderCollectorsTable();
                                }
                            }

                            resolve(data);
                            alert(data.mensagem || "Coletor excluído com sucesso!");
                        })
                        .catch(error => {
                            console.error('Erro ao excluir coletor:', error);
                            alert(`Erro ao excluir coletor: ${error.message}`);
                            reject(error);
                        });
                });
            }
        };

        // ===== Event Handlers =====

        // Adicionar botão excluir em cada linha da tabela
        function adicionarBotaoExcluir() {
            const linhasTabela = document.querySelectorAll('#collectorsTableBody tr');

            linhasTabela.forEach(linha => {
                // Verificar se a célula de ações já existe
                const celulasAcoes = linha.querySelector('td:last-child .actions');
                if (!celulasAcoes) return;

                // Verificar se o botão já existe
                if (celulasAcoes.querySelector('.btn-delete')) return;

                // Obter o ID do coletor
                const idColetor = linha.querySelector('td:first-child').textContent.replace('#', '').trim();

                // Criar botão excluir
                const botaoExcluir = document.createElement('button');
                botaoExcluir.className = 'btn-icon btn-delete';
                botaoExcluir.setAttribute('data-id', idColetor);
                botaoExcluir.setAttribute('title', 'Excluir coletor');
                botaoExcluir.innerHTML = '<i class="fas fa-trash"></i>'; // Ícone de lixeira
                botaoExcluir.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
                botaoExcluir.style.color = '#dc3545';

                // Adicionar evento ao botão
                botaoExcluir.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const id = this.getAttribute('data-id');
                    ApiService.excluirColetor(id)
                        .then(() => {
                            // Remover linha da tabela sem recarregar a página
                            linha.remove();

                            // Atualizar estatísticas
                            if (typeof updateStats === 'function') {
                                updateStats();
                            }
                        })
                        .catch(error => console.error('Falha ao excluir:', error));
                });

                // Adicionar botão ao container de ações
                celulasAcoes.appendChild(botaoExcluir);
            });
        }

        // ===== UI Updates =====

        // Atualizar a interface com os dados carregados
        function updateUI(data) {
            // Atualizar variável global de coletores
            window.collectors = data;

            // Renderizar tabela se a função existir
            if (typeof renderCollectorsTable === 'function') {
                renderCollectorsTable();
            }

            // Atualizar estatísticas se a função existir
            if (typeof updateStats === 'function') {
                updateStats();
            }

            // Atualizar lista de coletores ativos se a função existir
            if (typeof renderActiveCollectors === 'function') {
                renderActiveCollectors();
            }

            // Adicionar botões excluir após renderizar a tabela
            setTimeout(adicionarBotaoExcluir, 100);
        }

        // ===== Inicialização =====

        // Função principal de inicialização
        function init() {
            console.log("Inicializando sistema sincronizado com o banco de dados...");

            // Interceptar a função loadCollectors original
            if (typeof window.loadCollectors === 'function') {
                const originalLoadCollectors = window.loadCollectors;

                window.loadCollectors = function (forceRefresh = false) {
                    // Se forceRefresh for true, forçar atualização do servidor
                    if (forceRefresh) {
                        CacheManager.clearCache('coletores');
                        return ApiService.loadColetores(true);
                    }

                    // Tentar usar a função original primeiro
                    try {
                        return originalLoadCollectors();
                    } catch (error) {
                        // Fallback para nossa implementação
                        return ApiService.loadColetores();
                    }
                };
            } else {
                // Definir a função se não existir
                window.loadCollectors = function (forceRefresh = false) {
                    return ApiService.loadColetores(forceRefresh);
                };
            }

            // Sobrescrever a função de exclusão
            window.excluirColetor = function (idColetor) {
                return ApiService.excluirColetor(idColetor);
            };

            // Adicionar evento ao botão de atualizar
            const refreshButton = document.getElementById('refreshActiveCollectors');
            if (refreshButton) {
                refreshButton.addEventListener('click', function () {
                    // Limpar cache e forçar atualização do servidor
                    CacheManager.clearCache('coletores');
                    ApiService.loadColetores(true)
                        .then(() => {
                            // Adicionar botões excluir após atualizar os dados
                            setTimeout(adicionarBotaoExcluir, 100);
                        });
                });
            }

            // Carregar dados iniciais (do cache ou do servidor)
            ApiService.loadColetores()
                .then(() => {
                    // Adicionar botões excluir após carregar os dados
                    setTimeout(adicionarBotaoExcluir, 100);
                });

            // Adicionar observador de mutações para detectar atualizações da tabela
            const observer = new MutationObserver(function (mutations) {
                mutations.forEach(function (mutation) {
                    if (mutation.type === 'childList' &&
                        mutation.target.id === 'collectorsTableBody') {
                        setTimeout(adicionarBotaoExcluir, 100);
                    }
                });
            });

            // Configurar o observador
            const tableBody = document.getElementById('collectorsTableBody');
            if (tableBody) {
                observer.observe(tableBody, {
                    childList: true,
                    subtree: true
                });
            }
        }

        // Iniciar o sistema
        init();
    });


</script>




<script>
    // Complemento para estilização do botão excluir e garantia de funcionamento
    document.addEventListener('DOMContentLoaded', function () {
        // Adicionar estilos CSS para o botão excluir
        const style = document.createElement('style');
        style.textContent = `
        .btn-delete {
            background-color: rgba(220, 53, 69, 0.1) !important;
            color: #dc3545 !important;
            transition: all 0.3s ease !important;
        }
        
        .btn-delete:hover {
            background-color: #dc3545 !important;
            color: white !important;
        }
        
        /* Animação para remoção de linha */
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; transform: translateX(30px); }
        }
        
        .removing-row {
            animation: fadeOut 0.5s ease forwards;
        }
    `;
        document.head.appendChild(style);

        // Função para garantir que o botão de excluir seja adicionado
        function garantirBotaoExcluir() {
            // Encontrar todas as linhas da tabela
            const linhasTabela = document.querySelectorAll('#collectorsTableBody tr');

            linhasTabela.forEach(linha => {
                // Verificar se já existe o botão
                const acoes = linha.querySelector('td:last-child .actions');
                if (!acoes || acoes.querySelector('.btn-delete')) return;

                // Obter o ID do coletor
                const idTexto = linha.querySelector('td:first-child');
                if (!idTexto) return;

                const idColetor = idTexto.textContent.replace('#', '').trim();

                // Criar o botão excluir
                const botaoExcluir = document.createElement('button');
                botaoExcluir.className = 'btn-icon btn-delete';
                botaoExcluir.dataset.id = idColetor;
                botaoExcluir.title = 'Excluir coletor';
                botaoExcluir.innerHTML = '<i class="fas fa-trash"></i>';

                // Adicionar evento de clique
                botaoExcluir.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    // Confirmar exclusão
                    if (confirm(`Tem certeza que deseja excluir o coletor #${idColetor}?`)) {
                        // Animação de remoção
                        linha.classList.add('removing-row');

                        // Fazer requisição para a API
                        fetch(`/api/coletores/${idColetor}`, {
                            method: 'DELETE'
                        })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`Erro ao excluir coletor: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(data => {
                                // Aguardar a animação terminar
                                setTimeout(() => {
                                    // Remover a linha da tabela
                                    linha.remove();

                                    // Atualizar a lista de coletores global
                                    if (window.collectors && Array.isArray(window.collectors)) {
                                        window.collectors = window.collectors.filter(c => c.id !== idColetor);
                                    }

                                    // Atualizar estatísticas
                                    if (typeof updateStats === 'function') {
                                        updateStats();
                                    }

                                    // Atualizar lista de coletores ativos
                                    if (typeof renderActiveCollectors === 'function') {
                                        renderActiveCollectors();
                                    }

                                    // Exibir mensagem de sucesso
                                    alert(data.mensagem || "Coletor excluído com sucesso!");
                                }, 500);
                            })
                            .catch(error => {
                                // Remover animação em caso de erro
                                linha.classList.remove('removing-row');
                                console.error('Erro ao excluir coletor:', error);
                                alert(`Erro ao excluir coletor: ${error.message}`);
                            });
                    }
                });

                // Adicionar o botão às ações
                acoes.appendChild(botaoExcluir);
            });
        }

        // Garantir que o botão seja adicionado sempre que a tabela for modificada
        const observer = new MutationObserver(function (mutations) {
            garantirBotaoExcluir();
        });

        // Observar o corpo da tabela
        const tableBody = document.getElementById('collectorsTableBody');
        if (tableBody) {
            observer.observe(tableBody, {
                childList: true,
                subtree: true
            });
        }

        // Verificar a cada 2 segundos se novos itens foram adicionados
        setInterval(garantirBotaoExcluir, 2000);

        // Executar imediatamente
        setTimeout(garantirBotaoExcluir, 500);
    });

</script>


<script>

    // Script para persistência de estado entre reloads da página
    document.addEventListener('DOMContentLoaded', function () {
        // Chaves para armazenamento no localStorage
        const STORAGE_KEYS = {
            COLLECTORS: 'sistema_coletores_data',
            LAST_UPDATE: 'sistema_coletores_last_update',
            EXPIRATION: 60 * 60 * 1000 // 1 hora em milissegundos
        };

        // Verificar se existem dados em cache e se ainda são válidos
        function verificarCache() {
            const lastUpdate = localStorage.getItem(STORAGE_KEYS.LAST_UPDATE);
            if (!lastUpdate) return false;

            const now = Date.now();
            const updateTime = parseInt(lastUpdate, 10);

            // Verificar se o cache expirou
            if (now - updateTime > STORAGE_KEYS.EXPIRATION) {
                limparCache();
                return false;
            }

            return true;
        }

        // Limpar cache expirado
        function limparCache() {
            localStorage.removeItem(STORAGE_KEYS.COLLECTORS);
            localStorage.removeItem(STORAGE_KEYS.LAST_UPDATE);
        }

        // Salvar dados no localStorage
        function salvarDados(data) {
            localStorage.setItem(STORAGE_KEYS.COLLECTORS, JSON.stringify(data));
            localStorage.setItem(STORAGE_KEYS.LAST_UPDATE, Date.now().toString());
        }

        // Carregar dados do localStorage
        function carregarDados() {
            const data = localStorage.getItem(STORAGE_KEYS.COLLECTORS);
            return data ? JSON.parse(data) : null;
        }

        // Substituir a função loadCollectors original
        if (typeof window.loadCollectors === 'function') {
            const originalLoadCollectors = window.loadCollectors;

            window.loadCollectors = function (forceRefresh = false) {
                // Se forçar atualização, limpar cache e carregar do servidor
                if (forceRefresh) {
                    limparCache();
                    return originalLoadCollectors();
                }

                // Verificar se há dados em cache válidos
                if (verificarCache()) {
                    const cachedData = carregarDados();
                    if (cachedData) {
                        console.log('Carregando dados do cache local...');

                        // Atualizar a variável global
                        window.collectors = cachedData;

                        // Atualizar a interface
                        if (typeof updateStats === 'function') updateStats();
                        if (typeof renderActiveCollectors === 'function') renderActiveCollectors();
                        if (typeof renderCollectorsTable === 'function') renderCollectorsTable();

                        return Promise.resolve(cachedData);
                    }
                }

                // Se não houver cache ou estiver expirado, carregar do servidor
                return originalLoadCollectors().then(data => {
                    // Salvar os dados no cache
                    salvarDados(data);
                    return data;
                });
            };
        }

        // Interceptar a função saveCollector para atualizar o cache
        if (typeof window.saveCollector === 'function') {
            const originalSaveCollector = window.saveCollector;

            window.saveCollector = function () {
                // Chamar a função original primeiro
                const result = originalSaveCollector.apply(this, arguments);

                // Após salvar, atualizar o cache na próxima vez que os dados forem carregados
                limparCache();

                return result;
            };
        }

        // Atualizar o cache quando os coletores forem carregados com sucesso
        window.addEventListener('coletoresCarregados', function (e) {
            if (e.detail && e.detail.coletores) {
                salvarDados(e.detail.coletores);
            }
        });

        // Disparar evento quando os coletores forem carregados com sucesso
        const originalRenderCollectorsTable = window.renderCollectorsTable;
        if (typeof originalRenderCollectorsTable === 'function') {
            window.renderCollectorsTable = function () {
                // Chamar a função original
                originalRenderCollectorsTable.apply(this, arguments);

                // Disparar evento
                if (window.collectors) {
                    window.dispatchEvent(new CustomEvent('coletoresCarregados', {
                        detail: { coletores: window.collectors }
                    }));
                }
            };
        }
    });


</script>


<script>

    /**
 * Script para adicionar botão de excluir em cada linha da tabela de coletores
 */
    document.addEventListener('DOMContentLoaded', function () {
        console.log("Inicializando script para botão de excluir...");

        // Adicionar estilos CSS para o botão
        const style = document.createElement('style');
        style.textContent = `
        .btn-delete {
            background-color: rgba(220, 53, 69, 0.1) !important;
            color: #dc3545 !important;
            transition: all 0.3s ease !important;
            border: none !important;
            width: 35px !important;
            height: 35px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 5px !important;
            cursor: pointer !important;
            margin: 0 3px !important;
        }
        
        .btn-delete:hover {
            background-color: #dc3545 !important;
            color: white !important;
        }
        
        .btn-delete i {
            font-size: 14px !important;
        }
        
        /* Animação para remoção de linha */
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; transform: translateX(20px); }
        }
        
        .removing-row {
            animation: fadeOut 0.5s ease forwards;
        }
    `;
        document.head.appendChild(style);

        // Função para adicionar o botão excluir
        function adicionarBotaoExcluir() {
            // Encontrar todas as linhas da tabela
            const linhasTabela = document.querySelectorAll('#collectorsTableBody tr');

            linhasTabela.forEach(linha => {
                // Verificar se a célula de ações já existe
                const celulasAcoes = linha.querySelector('td:last-child .actions');
                if (!celulasAcoes) return;

                // Verificar se o botão já existe
                if (celulasAcoes.querySelector('.btn-delete')) return;

                // Obter o ID do coletor
                const idColetor = linha.querySelector('td:first-child')?.textContent.replace('#', '').trim();
                if (!idColetor) return;

                // Criar botão excluir
                const botaoExcluir = document.createElement('button');
                botaoExcluir.className = 'btn-icon btn-delete';
                botaoExcluir.setAttribute('data-id', idColetor);
                botaoExcluir.setAttribute('title', 'Excluir coletor');
                botaoExcluir.innerHTML = '<i class="fas fa-trash"></i>';

                // Adicionar evento ao botão
                botaoExcluir.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const id = this.getAttribute('data-id');
                    excluirColetor(id, linha);
                });

                // Adicionar botão ao container de ações
                celulasAcoes.appendChild(botaoExcluir);
            });
        }

        // Função para excluir o coletor
        function excluirColetor(idColetor, linha) {
            // Confirmar a exclusão
            if (!confirm(`Tem certeza que deseja excluir o coletor #${idColetor}?`)) {
                return;
            }

            console.log(`Excluindo coletor #${idColetor}`);

            // Aplicar animação de remoção
            linha.classList.add('removing-row');

            // Fazer requisição para a API
            fetch(`/api/coletores/${idColetor}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        // Remover a animação em caso de erro
                        linha.classList.remove('removing-row');

                        // Tratar o erro recebido da API
                        return response.json().then(data => {
                            throw new Error(data.erro || `Erro ao excluir coletor: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Resposta do servidor:', data);

                    // Aguardar o fim da animação para remover a linha
                    setTimeout(() => {
                        // Remover a linha da tabela
                        linha.remove();

                        // Atualizar a variável global
                        if (window.collectors && Array.isArray(window.collectors)) {
                            window.collectors = window.collectors.filter(c => c.id !== idColetor);
                        }

                        // Atualizar estatísticas
                        if (typeof updateStats === 'function') {
                            updateStats();
                        }

                        // Atualizar lista de coletores ativos
                        if (typeof renderActiveCollectors === 'function') {
                            renderActiveCollectors();
                        }

                        // Mostrar mensagem de sucesso
                        alert(data.mensagem || "Coletor excluído com sucesso!");
                    }, 500); // Esperar 500ms para a animação terminar
                })
                .catch(error => {
                    console.error('Erro ao excluir coletor:', error);
                    alert(`Erro ao excluir coletor: ${error.message}`);

                    // Remover a animação em caso de erro
                    linha.classList.remove('removing-row');
                });
        }

        // Observar mudanças na tabela para adicionar o botão em novas linhas
        const observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
                if (mutation.type === 'childList' &&
                    (mutation.target.id === 'collectorsTableBody' ||
                        mutation.target.closest('#collectorsTableBody'))) {
                    setTimeout(adicionarBotaoExcluir, 100);
                }
            });
        });

        // Configurar o observador para a tabela
        const tableBody = document.getElementById('collectorsTableBody');
        if (tableBody) {
            observer.observe(tableBody, {
                childList: true,
                subtree: true
            });
            console.log('Observer configurado para a tabela de coletores');
        }

        // Adicionar botões às linhas existentes
        setTimeout(adicionarBotaoExcluir, 500);

        // Verificar periodicamente por novas linhas sem botão
        setInterval(adicionarBotaoExcluir, 2000);

        console.log("Script para botão de excluir inicializado com sucesso");
    });

</script>

<script>

    /**
 * Script para persistência de dados entre atualizações da página
 * Evita recarregar dados do banco de dados a cada refresh
 */
    document.addEventListener('DOMContentLoaded', function () {
        console.log("Inicializando sistema de persistência de dados...");

        // Configurações
        const CONFIG = {
            STORAGE_KEY: 'sistema_coletores_dados',
            EXPIRACAO: 30 * 60 * 1000, // 30 minutos em milissegundos
            VERSAO: '1.0.0'
        };

        // ===== Cache Manager =====
        const CacheManager = {
            /**
             * Salva dados no cache local
             */
            salvar: function (chave, dados) {
                try {
                    const dadosCache = {
                        timestamp: Date.now(),
                        versao: CONFIG.VERSAO,
                        dados: dados
                    };

                    localStorage.setItem(`${CONFIG.STORAGE_KEY}_${chave}`, JSON.stringify(dadosCache));
                    console.log(`Dados salvos no cache: ${chave}`);
                    return true;
                } catch (error) {
                    console.error(`Erro ao salvar no cache: ${error.message}`);
                    return false;
                }
            },

            /**
             * Recupera dados do cache se não estiverem expirados
             */
            recuperar: function (chave) {
                try {
                    const dadosCache = localStorage.getItem(`${CONFIG.STORAGE_KEY}_${chave}`);
                    if (!dadosCache) return null;

                    const parsedData = JSON.parse(dadosCache);
                    const agora = Date.now();

                    // Verificar se o cache expirou
                    if (agora - parsedData.timestamp > CONFIG.EXPIRACAO) {
                        console.log(`Cache expirado para: ${chave}`);
                        localStorage.removeItem(`${CONFIG.STORAGE_KEY}_${chave}`);
                        return null;
                    }

                    // Verificar se a versão é compatível
                    if (parsedData.versao !== CONFIG.VERSAO) {
                        console.log(`Versão do cache incompatível para: ${chave}`);
                        localStorage.removeItem(`${CONFIG.STORAGE_KEY}_${chave}`);
                        return null;
                    }

                    console.log(`Dados recuperados do cache: ${chave}`);
                    return parsedData.dados;
                } catch (error) {
                    console.error(`Erro ao recuperar do cache: ${error.message}`);
                    return null;
                }
            },

            /**
             * Limpa cache de uma chave específica
             */
            limpar: function (chave) {
                localStorage.removeItem(`${CONFIG.STORAGE_KEY}_${chave}`);
                console.log(`Cache limpo: ${chave}`);
            },

            /**
             * Limpa todo o cache do sistema
             */
            limparTudo: function () {
                const chavesParaRemover = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const chave = localStorage.key(i);
                    if (chave && chave.startsWith(CONFIG.STORAGE_KEY)) {
                        chavesParaRemover.push(chave);
                    }
                }

                chavesParaRemover.forEach(chave => localStorage.removeItem(chave));
                console.log(`Todo o cache do sistema foi limpo`);
            }
        };

        // ===== Sobrecarga de funções originais =====

        /**
         * Sobrescreve a função loadCollectors para usar o cache
         */
        function sobrescreverLoadCollectors() {
            if (typeof window.loadCollectors === 'function') {
                console.log('Sobrescrevendo função loadCollectors para usar cache');

                const loadCollectorsOriginal = window.loadCollectors;

                window.loadCollectors = function (forceRefresh = false) {
                    console.log(`Carregando coletores (forceRefresh: ${forceRefresh})`);

                    // Se forçar atualização, limpar cache e carregar do servidor
                    if (forceRefresh) {
                        CacheManager.limpar('coletores');
                        return loadCollectorsOriginal();
                    }

                    // Tentar recuperar do cache
                    const dadosCache = CacheManager.recuperar('coletores');
                    if (dadosCache) {
                        // Atualizar a variável global
                        window.collectors = dadosCache;

                        // Atualizar interface
                        if (typeof updateStats === 'function') {
                            updateStats();
                        }

                        if (typeof renderActiveCollectors === 'function') {
                            renderActiveCollectors();
                        }

                        if (typeof renderCollectorsTable === 'function') {
                            renderCollectorsTable();
                        }

                        return Promise.resolve(dadosCache);
                    }

                    // Se não houver cache, carregar do servidor
                    return loadCollectorsOriginal().then(data => {
                        // Salvar os dados obtidos no cache
                        CacheManager.salvar('coletores', data);
                        return data;
                    });
                };
            } else {
                console.warn('Função loadCollectors não encontrada para sobrescrita');
            }
        }

        /**
         * Sobrescreve a função loadUsers para usar o cache
         */
        function sobrescreverLoadUsers() {
            if (typeof window.loadUsers === 'function') {
                console.log('Sobrescrevendo função loadUsers para usar cache');

                const loadUsersOriginal = window.loadUsers;

                window.loadUsers = function (forceRefresh = false) {
                    console.log(`Carregando usuários (forceRefresh: ${forceRefresh})`);

                    // Se forçar atualização, limpar cache e carregar do servidor
                    if (forceRefresh) {
                        CacheManager.limpar('usuarios');
                        return loadUsersOriginal();
                    }

                    // Tentar recuperar do cache
                    const dadosCache = CacheManager.recuperar('usuarios');
                    if (dadosCache) {
                        // Atualizar a variável global
                        window.users = dadosCache;

                        // Atualizar interface
                        if (typeof updateUserSelect === 'function') {
                            updateUserSelect();
                        }

                        return Promise.resolve(dadosCache);
                    }

                    // Se não houver cache, carregar do servidor
                    return loadUsersOriginal().then(data => {
                        // Salvar os dados obtidos no cache
                        CacheManager.salvar('usuarios', data);
                        return data;
                    });
                };
            } else {
                console.warn('Função loadUsers não encontrada para sobrescrita');
            }
        }

        /**
         * Sobrescreve a função saveCollector para limpar o cache após salvar
         */
        function sobrescreverSaveCollector() {
            if (typeof window.saveCollector === 'function') {
                console.log('Sobrescrevendo função saveCollector para limpar cache ao salvar');

                const saveCollectorOriginal = window.saveCollector;

                window.saveCollector = function () {
                    console.log('Salvando coletor e limpando cache');

                    // Chamar a função original
                    return saveCollectorOriginal.apply(this, arguments).then(result => {
                        // Limpar o cache após salvar com sucesso
                        CacheManager.limpar('coletores');
                        return result;
                    });
                };
            } else {
                console.warn('Função saveCollector não encontrada para sobrescrita');
            }
        }

        /**
         * Sobrescreve a função saveUser para limpar o cache após salvar
         */
        function sobrescreverSaveUser() {
            if (typeof window.saveUser === 'function') {
                console.log('Sobrescrevendo função saveUser para limpar cache ao salvar');

                const saveUserOriginal = window.saveUser;

                window.saveUser = function () {
                    console.log('Salvando usuário e limpando cache');

                    // Chamar a função original
                    return saveUserOriginal.apply(this, arguments).then(result => {
                        // Limpar o cache após salvar com sucesso
                        CacheManager.limpar('usuarios');
                        return result;
                    });
                };
            } else {
                console.warn('Função saveUser não encontrada para sobrescrita');
            }
        }

        // ===== Listeners para atualização de cache =====

        /**
         * Intercepta eventos para atualizar o cache
         */
        function configurarInterceptadores() {
            // Interceptar o evento de renderização da tabela para atualizar o cache
            const originalRenderCollectorsTable = window.renderCollectorsTable;
            if (typeof originalRenderCollectorsTable === 'function') {
                window.renderCollectorsTable = function () {
                    // Chamar a função original
                    originalRenderCollectorsTable.apply(this, arguments);

                    // Salvar os dados no cache se disponíveis
                    if (window.collectors && Array.isArray(window.collectors)) {
                        CacheManager.salvar('coletores', window.collectors);
                    }
                };
            }

            // Interceptar cliques nos botões que atualizam dados
            document.addEventListener('click', function (event) {
                // Botão de atualizar coletores ativos
                if (event.target.id === 'refreshActiveCollectors' ||
                    (event.target.parentElement && event.target.parentElement.id === 'refreshActiveCollectors')) {
                    console.log('Clique em botão de atualizar detectado, limpando cache');
                    CacheManager.limpar('coletores');
                }
            });

            // Interceptar submissão de formulários
            document.addEventListener('submit', function (event) {
                // Verificar se é o formulário de coletor
                if (event.target.id === 'collectorForm') {
                    console.log('Submissão de formulário de coletor detectada, limpando cache');
                    CacheManager.limpar('coletores');
                }

                // Verificar se é o formulário de usuário
                if (event.target.id === 'userForm') {
                    console.log('Submissão de formulário de usuário detectada, limpando cache');
                    CacheManager.limpar('usuarios');
                }
            });
        }

        // ===== Inicialização =====

        /**
         * Inicializa o sistema de persistência
         */
        function init() {
            console.log('Iniciando sistema de persistência de dados...');

            // Sobrescrever funções existentes
            sobrescreverLoadCollectors();
            sobrescreverLoadUsers();
            sobrescreverSaveCollector();
            sobrescreverSaveUser();

            // Configurar interceptadores para atualização de cache
            configurarInterceptadores();

            // Adicionar botão para limpar cache (opcional, útil para testes)
            const adicionarBotaoLimparCache = false;
            if (adicionarBotaoLimparCache) {
                const botao = document.createElement('button');
                botao.textContent = 'Limpar Cache';
                botao.style.position = 'fixed';
                botao.style.bottom = '10px';
                botao.style.left = '10px';
                botao.style.zIndex = '9999';
                botao.addEventListener('click', function () {
                    CacheManager.limparTudo();
                    alert('Cache limpo! Atualize a página para recarregar os dados.');
                });
                document.body.appendChild(botao);
            }

            console.log('Sistema de persistência de dados inicializado com sucesso');
        }

        // Iniciar o sistema
        init();
    });

</script>

<script>
    // Função para devolver o coletor
    function devolverColetor(idColetor, linha) {
        // Confirmar a devolução
        if (!confirm(`Confirmar devolução do coletor #${idColetor}?`)) {
            return;
        }

        console.log(`Devolvendo coletor #${idColetor}`);

        // Obter dados necessários para a devolução
        const usuarioCell = linha.querySelector('td:nth-child(2)');
        const setorCell = linha.querySelector('td:nth-child(3)');
        const statusCell = linha.querySelector('td:nth-child(4)');
        const tempoUsoCell = linha.querySelector('td:nth-child(5)');
        const bateriaCell = linha.querySelector('td:nth-child(6)');

        const usuarioAtual = usuarioCell ? usuarioCell.textContent.trim() : '-';
        const setorAtual = setorCell ? setorCell.textContent.trim() : '-';
        const statusAtual = statusCell ? statusCell.querySelector('span').textContent.trim() : '';
        const tempoUsoAtual = tempoUsoCell ? tempoUsoCell.textContent.trim() : '00:00';
        const bateriaAtual = bateriaCell ? bateriaCell.textContent.trim() : '100%';

        // Obter data e hora atual
        const hoje = new Date();
        const dataAtual = hoje.toLocaleDateString('pt-BR');
        const horaAtual = hoje.getHours().toString().padStart(2, '0') + ':' +
            hoje.getMinutes().toString().padStart(2, '0');

        // Dados para enviar ao servidor
        const dados = {
            usuario: usuarioAtual,
            setor: setorAtual,
            status_anterior: statusAtual,
            tempo_uso: tempoUsoAtual,
            bateria: bateriaAtual.replace('%', ''),
            data_devolucao: dataAtual,
            hora_devolucao: horaAtual,
            observacoes: "Devolvido via botão Devolver"
        };

        // Enviar requisição para o servidor
        fetch(`/api/coletores/${idColetor}/devolver`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dados)
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.erro || `Erro ao devolver coletor: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Resposta do servidor:', data);

                // Aplicar mudanças à linha da tabela
                if (usuarioCell) usuarioCell.textContent = '-';
                if (setorCell) setorCell.textContent = '-';

                // Atualizar o status
                if (statusCell) {
                    const statusSpan = statusCell.querySelector('span');
                    if (statusSpan) {
                        statusSpan.className = 'status status-disponivel';
                        statusSpan.textContent = 'Disponível para Uso';
                    }
                }

                // Zerar o tempo de uso
                if (tempoUsoCell) tempoUsoCell.textContent = '00:00';

                // Remover o botão de devolução
                const botaoDevolver = linha.querySelector('.btn-return');
                if (botaoDevolver) {
                    botaoDevolver.remove();
                }

                // Atualizar a lista de coletores em memória
                if (window.collectors && Array.isArray(window.collectors)) {
                    const coletor = window.collectors.find(c => c.id === idColetor);
                    if (coletor) {
                        coletor.usuario = '-';
                        coletor.setor = '-';
                        coletor.status = 'Disponível para Uso';
                        coletor.tempo_uso = '00:00';
                    }
                }

                // Atualizar estatísticas
                if (typeof updateStats === 'function') {
                    updateStats();
                }

                // Atualizar lista de coletores ativos
                if (typeof renderActiveCollectors === 'function') {
                    renderActiveCollectors();
                }

                // Mostrar mensagem de sucesso
                alert(`Coletor #${idColetor} devolvido com sucesso!`);
            })
            .catch(error => {
                console.error('Erro ao devolver coletor:', error);
                alert(`Erro ao devolver coletor: ${error.message}`);
            });
    }

</script>

<script>
    // Script para tornar os botões de ações sempre visíveis
    document.addEventListener('DOMContentLoaded', function () {
        // Adicionar CSS para garantir que os botões sejam sempre visíveis
        const style = document.createElement('style');
        style.textContent = `
        /* Tornar todos os botões nas células de ações sempre visíveis */
        .actions .btn-icon,
        td:last-child .actions .btn-icon,
        .actions button,
        td:last-child .actions button {
            opacity: 1 !important;
            visibility: visible !important;
            display: flex !important;
        }
        
        /* Garantir que o contêiner de ações também seja sempre visível */
        .actions,
        td:last-child .actions {
            opacity: 1 !important;
            visibility: visible !important;
            display: flex !important;
        }
        
        /* Corrigir hover que pode estar escondendo os botões */
        tr:hover .actions,
        tr:hover .btn-icon,
        tr:hover button {
            opacity: 1 !important;
            visibility: visible !important;
            display: flex !important;
        }
    `;
        document.head.appendChild(style);

        // Forçar a visibilidade de todos os botões na tabela
        function tornarBotoesVisiveis() {
            const botoes = document.querySelectorAll('.actions .btn-icon, td:last-child .actions button');
            botoes.forEach(botao => {
                botao.style.opacity = '1';
                botao.style.visibility = 'visible';
                botao.style.display = 'flex';
            });

            const containersAcoes = document.querySelectorAll('.actions, td:last-child .actions');
            containersAcoes.forEach(container => {
                container.style.opacity = '1';
                container.style.visibility = 'visible';
                container.style.display = 'flex';
            });
        }

        // Executar imediatamente
        tornarBotoesVisiveis();

        // Executar novamente após um pequeno atraso (para garantir que funcione após carregamento dinâmico)
        setTimeout(tornarBotoesVisiveis, 500);

        // Configurar um observer para detectar quando novas linhas são adicionadas à tabela
        const observer = new MutationObserver(function (mutations) {
            tornarBotoesVisiveis();
        });

        // Observar a tabela de coletores
        const tabela = document.querySelector('table');
        if (tabela) {
            observer.observe(tabela, {
                childList: true,
                subtree: true
            });
        }

        // Verificar periodicamente por novos botões
        setInterval(tornarBotoesVisiveis, 2000);
    });

</script>

<script>
    // Adicionar no final do arquivo script.js ou no próprio index.html dentro de uma tag <script>
    document.addEventListener('DOMContentLoaded', function () {
        // Botão para ir para a página de seleção de coletores
        const btnSelectionPage = document.getElementById('btnSelectionPage');
        if (btnSelectionPage) {
            btnSelectionPage.addEventListener('click', function () {
                window.location.href = '/selecao-coletores';
            });
        }
    });

</script>

<script>
    // Botão para ir para a página de seleção de coletores
    document.addEventListener('DOMContentLoaded', function () {
        const btnSelectionPage = document.getElementById('btnSelectionPage');
        if (btnSelectionPage) {
            btnSelectionPage.addEventListener('click', function () {
                window.location.href = '/selecao-coletores';
            });
        }
    });
</script>

</body>

</html>